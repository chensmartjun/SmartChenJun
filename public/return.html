<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>退货管理</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/theme-chalk/index.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { width: 100%; height: 100%; font-family: Arial, sans-serif; }
    .content { padding: 10px; overflow-y: auto; background: #f0f0f0; }
    .operation-bar {
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .pagination-buttons img {
      width: 30px;
      height: 30px;
      margin: 0 5px;
      cursor: pointer;
    }
    .pagination-buttons img.gray { opacity: 0.5; cursor: not-allowed; }
    .utility-buttons { display: flex; gap: 2px; }
    .utility-buttons .el-button, .action-buttons .el-button { height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
    .utility-buttons .el-button { color: #fff; border-color: #dcdcdc; }
    .utility-buttons .filter-btn { background-color: #9B59B6; }
    .utility-buttons .import-btn { background-color: #1ABC9C; }
    .utility-buttons .export-btn { background-color: #F1C40F; }
    .action-buttons { display: flex; flex-direction: row-reverse; gap: 2px; }
    .action-buttons .el-button { color: #fff; border-color: transparent; }
    .action-buttons .add-btn { background-color: #409EFF; }
    .action-buttons .edit-btn { background-color: #E6A23C; }
    .action-buttons .delete-btn { background-color: #F56C6C; }
    .action-buttons .save-btn { background-color: #67C23A; }
    .action-buttons .withdraw-btn { background-color: #E91E63; }
    .action-buttons .print-btn { background-color: #7F8C8D; }
    .utility-buttons .el-button:hover, .action-buttons .el-button:hover { opacity: 0.9; }
    .form-section { background: #fff; padding: 20px; border-radius: 4px; margin-bottom: 10px; }
    .table-section { background: #fff; padding: 20px; border-radius: 4px; }
    .summary-section { background: #fff; padding: 10px; border-radius: 4px; margin-top: 10px; }
    @media print {
      .operation-bar, .form-section { display: none; }
      .table-section { display: block !important; padding: 0; }
      .el-table th, .el-table td { font-size: 10pt; padding: 2px; }
      .summary-section { font-size: 10pt; padding: 5px; }
    }
  </style>
</head>
<body>
  <div id="app" class="content">
    <div class="operation-bar">
      <div style="display: flex; align-items: center;">
        <div class="pagination-buttons">
          <img src="material/Page 1.png" alt="第一页" :class="{ gray: currentPage === 1 }" @click="goFirstPage">
          <img src="material/Previous Page.png" alt="上一页" :class="{ gray: currentPage === 1 }" @click="goPrevPage">
          <img src="material/Next Page.png" alt="下一页" :class="{ gray: currentPage === Math.ceil(total / pageSize) }" @click="goNextPage">
          <img src="material/Last Page.png" alt="最后一页" :class="{ gray: currentPage === Math.ceil(total / pageSize) }" @click="goLastPage">
        </div>
        <div class="utility-buttons">
          <el-button type="default" size="small" icon="el-icon-search" class="filter-btn" @click="fetchReturnOrders">筛选</el-button>
          <el-button type="default" size="small" icon="el-icon-upload" class="import-btn" @click="importData">导入</el-button>
          <el-button type="default" size="small" icon="el-icon-download" class="export-btn" @click="exportData">导出</el-button>
        </div>
      </div>
      <div class="action-buttons">
        <el-button type="default" size="small" icon="el-icon-printer" class="print-btn" @click="printVoucher">打印</el-button>
        <el-button type="default" size="small" class="withdraw-btn" @click="withdraw">撤回</el-button>
        <el-button type="default" size="small" class="save-btn" @click="saveReturnOrder" :disabled="!currentReturnOrder">保存</el-button>
        <el-button type="default" size="small" class="delete-btn" @click="deleteReturnOrder" :disabled="selectedRows.length === 0">删除</el-button>
        <el-button type="default" size="small" class="edit-btn" @click="editReturnOrder" :disabled="selectedRows.length !== 1">修改</el-button>
        <el-button type="default" size="small" class="add-btn" @click="addReturnOrder">新建</el-button>
      </div>
    </div>
    <div class="form-section" v-if="currentReturnOrder">
      <el-form :model="currentReturnOrder" :rules="returnRules" ref="returnForm" label-width="100px">
        <el-row :gutter="20">
          <el-col :span="6">
            <el-form-item label="退货单号" prop="order_number">
              <el-input v-model="currentReturnOrder.order_number" disabled></el-input>
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="日期" prop="date">
              <el-input v-model="currentReturnOrder.date" disabled></el-input>
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="退货类型" prop="type">
              <el-select v-model="currentReturnOrder.type" placeholder="请选择退货类型" @change="updateReturnOptions">
                <el-option label="客户退货" value="customer"></el-option>
                <el-option label="供应商退货" value="supplier"></el-option>
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="客户/供应商" prop="entity_id">
              <el-select v-model="currentReturnOrder.entity_id" placeholder="请选择" :disabled="!currentReturnOrder.type" @change="updateReturnOptions">
                <el-option v-for="item in currentReturnOrder.type === 'customer' ? customers : suppliers" :key="item.id" :label="item.short_name" :value="item.id"></el-option>
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
      </el-form>
    </div>
    <div class="form-section" v-if="currentReturnOrder && currentReturnOrder.type">
      <el-table :data="returnableItems" border style="width: 100%;" @selection-change="handleDetailSelectionChange">
        <el-table-column type="selection" width="55"></el-table-column>
        <el-table-column label="序号" type="index" width="60"></el-table-column>
        <el-table-column label="条形码" prop="barcode" width="150"></el-table-column>
        <el-table-column label="产品编码" prop="product_code" width="120"></el-table-column>
        <el-table-column label="产品名称" prop="product_name" width="150"></el-table-column>
        <el-table-column label="金重" prop="weight" width="80"></el-table-column>
        <el-table-column label="净金重" prop="pure_weight" width="80"></el-table-column>
        <el-table-column label="工费" prop="labor_cost" width="80"></el-table-column>
        <el-table-column label="件数" prop="quantity" width="80"></el-table-column>
        <el-table-column label="总工费" prop="total_cost" width="100"></el-table-column>
      </el-table>
    </div>
    <div class="summary-section" v-if="currentReturnOrder && currentReturnOrder.details.length > 0">
      <el-row>
        <el-col :span="6">总金重: {{ (currentReturnOrder.total_weight || 0).toFixed(3) }} g</el-col>
        <el-col :span="6">总净金重: {{ (currentReturnOrder.total_pure_weight || 0).toFixed(3) }} g</el-col>
        <el-col :span="6">总费用: {{ (currentReturnOrder.total_cost || 0).toFixed(2) }} 元</el-col>
      </el-row>
    </div>
    <div class="table-section">
      <el-table :data="returnOrders" border style="width: 100%;" @selection-change="handleSelectionChange">
        <el-table-column type="selection" width="55"></el-table-column>
        <el-table-column prop="order_number" label="退货单号"></el-table-column>
        <el-table-column prop="date" label="日期"></el-table-column>
        <el-table-column prop="type" label="类型"></el-table-column>
        <el-table-column prop="customer.short_name" label="客户"></el-table-column>
        <el-table-column prop="supplier.short_name" label="供应商"></el-table-column>
        <el-table-column prop="total_cost" label="总费用"></el-table-column>
      </el-table>
    </div>
  </div>

  <script>
    new Vue({
      el: '#app',
      data() {
        return {
          suppliers: [],
          customers: [],
          returnOrders: [],
          currentReturnOrder: {},
          returnableItems: [],
          selectedRows: [],
          selectedDetails: [],
          filter: {
            type: '',
            date: '',
          },
          currentPage: 1,
          pageSize: 10,
          total: 0,
          returnRules: {
            type: [{ required: true, message: '请选择退货类型', trigger: 'change' }],
            entity_id: [{ required: true, message: '请选择客户或供应商', trigger: 'change' }],
          },
        };
      },
      methods: {
        fetchSuppliers() {
          axios.get('/api/suppliers', { params: { page: 1, size: 999 } })
            .then(response => this.suppliers = response.data.data || [])
            .catch(error => console.error('Fetch suppliers error:', error));
        },
        fetchCustomers() {
          axios.get('/api/customers', { params: { page: 1, size: 999 } })
            .then(response => this.customers = response.data.data || [])
            .catch(error => console.error('Fetch customers error:', error));
        },
        fetchReturnOrders() {
          const params = { page: this.currentPage, size: this.pageSize, ...this.filter };
          if (params.date) params.date = this.formatDate(new Date(params.date), 'yyyy-MM-dd');
          axios.get('/api/returnOrders', { params })
            .then(response => {
              this.returnOrders = response.data.data || [];
              this.total = response.data.total || 0;
            })
            .catch(error => console.error('Fetch returnOrders error:', error));
        },
        goFirstPage() {
          if (this.currentPage !== 1) {
            this.currentPage = 1;
            this.fetchReturnOrders();
          }
        },
        goPrevPage() {
          if (this.currentPage > 1) {
            this.currentPage--;
            this.fetchReturnOrders();
          }
        },
        goNextPage() {
          if (this.currentPage < Math.ceil(this.total / this.pageSize)) {
            this.currentPage++;
            this.fetchReturnOrders();
          }
        },
        goLastPage() {
          if (this.currentPage !== Math.ceil(this.total / this.pageSize)) {
            this.currentPage = Math.ceil(this.total / this.pageSize);
            this.fetchReturnOrders();
          }
        },
                addReturnOrder() {
          const orderNumber = `RET${this.formatDate(new Date(), 'yyyyMMdd')}${String(this.returnOrders.length + 1).padStart(4, '0')}`;
          this.currentReturnOrder = {
            order_number: orderNumber,
            date: this.formatDate(new Date(), 'yyyy-MM-dd'),
            type: '',
            entity_id: '',
            details: [],
            total_weight: 0,
            total_pure_weight: 0,
            total_cost: 0,
          };
          this.returnableItems = [];
          this.selectedDetails = [];
        },
        editReturnOrder() {
          if (this.selectedRows.length === 1) {
            axios.get(`/api/returnOrders/${this.selectedRows[0].id}`)
              .then(response => {
                this.currentReturnOrder = response.data;
                this.currentReturnOrder.details = this.currentReturnOrder.ReturnOrderDetails || [];
                this.currentReturnOrder.entity_id = this.currentReturnOrder.customer_id || this.currentReturnOrder.supplier_id;
                this.updateReturnOptions();
                this.calculateTotals();
              })
              .catch(error => console.error('Edit error:', error));
          }
        },
        deleteReturnOrder() {
          if (this.selectedRows.length > 0) {
            if (confirm('确定删除选中的记录？')) {
              const promises = this.selectedRows.map(row => axios.delete(`/api/returnOrders/${row.id}`));
              Promise.all(promises)
                .then(() => {
                  alert('删除成功');
                  this.fetchReturnOrders();
                })
                .catch(error => alert('删除失败：' + error.message));
            }
          }
        },
        async saveReturnOrder() {
          await this.$refs['returnForm'].validate(async (valid) => {
            if (valid) {
              if (this.selectedDetails.length === 0) {
                alert('请至少选择一项退货产品');
                return;
              }
              this.currentReturnOrder.details = this.selectedDetails;
              if (this.currentReturnOrder.type === 'customer') {
                this.currentReturnOrder.customer_id = this.currentReturnOrder.entity_id;
                this.currentReturnOrder.supplier_id = null;
              } else if (this.currentReturnOrder.type === 'supplier') {
                this.currentReturnOrder.supplier_id = this.currentReturnOrder.entity_id;
                this.currentReturnOrder.customer_id = null;
              }
              const method = this.currentReturnOrder.id ? 'put' : 'post';
              const url = this.currentReturnOrder.id ? `/api/returnOrders/${this.currentReturnOrder.id}` : '/api/returnOrders';
              const response = await axios[method](url, this.currentReturnOrder);
              alert('保存成功');
              // 更新库存
              const updateType = this.currentReturnOrder.type === 'customer' ? 'return_in' : 'return_out';
              await axios.post('/api/inventory/update', {
                details: this.currentReturnOrder.details,
                type: updateType
              });
              // 更新客户或供应商欠款
              if (this.currentReturnOrder.type === 'customer') {
                await axios.post('/api/owed/update', {
                  customer_id: this.currentReturnOrder.customer_id,
                  material: -this.currentReturnOrder.total_pure_weight,
                  labor: -this.currentReturnOrder.total_cost,
                  type: 'return'
                });
              }
              this.currentReturnOrder = {};
              this.returnableItems = [];
              this.selectedDetails = [];
              this.fetchReturnOrders();
              if (this.currentReturnOrder.type === 'customer') {
                this.printBarcodes(response.data.details.map(d => d.barcode));
              }
            } else {
              alert('请填写必填项');
            }
          });
        },
        withdraw() {
          this.currentReturnOrder = {};
          this.returnableItems = [];
          this.selectedDetails = [];
          alert('已回撤');
        },
        updateReturnOptions() {
          this.returnableItems = [];
          this.selectedDetails = [];
          if (this.currentReturnOrder.type === 'customer' && this.currentReturnOrder.entity_id) {
            axios.get('/api/outboundOrders', { params: { customer_id: this.currentReturnOrder.entity_id } })
              .then(response => {
                this.returnableItems = response.data.data.flatMap(order => order.OutboundOrderDetails) || [];
              });
          } else if (this.currentReturnOrder.type === 'supplier' && this.currentReturnOrder.entity_id) {
            axios.get('/api/inboundOrders', { params: { supplier_id: this.currentReturnOrder.entity_id } })
              .then(response => {
                this.returnableItems = response.data.data.flatMap(order => order.InboundOrderDetails) || [];
              });
          }
        },
        handleDetailSelectionChange(val) {
          this.selectedDetails = val;
          this.currentReturnOrder.details = val;
          this.calculateTotals();
        },
        calculateTotals() {
          const details = this.currentReturnOrder.details;
          this.currentReturnOrder.total_weight = details.reduce((sum, item) => sum + (item.weight * item.quantity), 0);
          this.currentReturnOrder.total_pure_weight = details.reduce((sum, item) => sum + ((item.pure_weight || item.weight) * item.quantity), 0);
          this.currentReturnOrder.total_cost = details.reduce((sum, item) => sum + (item.total_cost || 0), 0);
        },
        printVoucher() {
          if (this.currentReturnOrder && this.currentReturnOrder.id) {
            axios.post('/api/printVoucher', { type: 'return', order_id: this.currentReturnOrder.id }, { responseType: 'blob' })
              .then(response => {
                const url = window.URL.createObjectURL(new Blob([response.data]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `return_voucher_${this.currentReturnOrder.order_number}.xlsx`);
                document.body.appendChild(link);
                link.click();
              });
          } else if (this.selectedRows.length > 0) {
            this.selectedRows.forEach(row => {
              axios.post('/api/printVoucher', { type: 'return', order_id: row.id }, { responseType: 'blob' })
                .then(response => {
                  const url = window.URL.createObjectURL(new Blob([response.data]));
                  const link = document.createElement('a');
                  link.href = url;
                  link.setAttribute('download', `return_voucher_${row.order_number}.xlsx`);
                  document.body.appendChild(link);
                  link.click();
                });
            });
          }
        },
        printBarcodes(barcodes) {
          axios.post('/api/printBarcodes', { barcodes, template: 'default' }, { responseType: 'blob' })
            .then(response => {
              const url = window.URL.createObjectURL(new Blob([response.data]));
              const link = document.createElement('a');
              link.href = url;
              link.setAttribute('download', `barcodes_${this.currentReturnOrder.order_number}.pdf`);
              document.body.appendChild(link);
              link.click();
            });
        },
        importData() {
          alert('导入功能待实现');
        },
        exportData() {
          const data = this.returnOrders.map(order => ({
            order_number: order.order_number,
            date: order.date,
            type: order.type,
            customer: order.customer?.short_name,
            supplier: order.supplier?.short_name,
            total_cost: order.total_cost,
          }));
          const worksheet = XLSX.utils.json_to_sheet(data);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, 'ReturnOrders');
          const buffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
          const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.setAttribute('download', `return_orders_${this.formatDate(new Date(), 'yyyyMMdd')}.xlsx`);
          document.body.appendChild(link);
          link.click();
        },
        handleSelectionChange(val) {
          this.selectedRows = val;
        },
        formatDate(date, formatStr) {
          const pad = (num) => String(num).padStart(2, '0');
          const year = date.getFullYear();
          const month = pad(date.getMonth() + 1);
          const day = pad(date.getDate());
          if (formatStr === 'yyyyMMdd') return `${year}${month}${day}`;
          if (formatStr === 'yyyy-MM-dd') return `${year}-${month}-${day}`;
          return date.toISOString().split('T')[0];
        },
      },
      mounted() {
        console.log('Mounted, fetching data...');
        this.fetchSuppliers();
        this.fetchCustomers();
        this.fetchReturnOrders();
      },
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'91fa6c486817afec',t:'MTc0MTg1NzI4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>