<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>系统设置</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/theme-chalk/index.css">
  <script src="/lib/vue.min.js"></script>
  <script src="/lib/element-ui/index.js"></script>
  <script src="/lib/axios.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
      width: 100%;
      min-height: 100vh; /* Allow the page to grow beyond viewport */
      font-family: Arial, sans-serif;
      overflow-x: hidden; /* Prevent horizontal scroll */
    }
    .wrapper {
      width: 100%;
      display: flex;
      flex-direction: column;
      /* Remove min-height to allow natural growth */
    }
    .main-content {
      display: flex;
      flex: 1 0 auto; /* Allow growth based on content */
    }
    .sidebar {
      width: 200px;
      flex-shrink: 0;
    }
    .content-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      /* Remove overflow restriction */
    }
    .content {
      flex: 1 0 auto; /* Allow growth based on content */
      padding: 10px;
      background: #f0f0f0;
    }
    .operation-bar {
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0; /* Prevent shrinking */
    }
    .pagination-buttons img {
      width: 30px;
      height: 30px;
      margin: 0 5px;
      cursor: pointer;
    }
    .pagination-buttons img.gray { opacity: 0.5; cursor: not-allowed; }
    .el-button {
      padding: 0px 12px;
      font-size: 12px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 80px;
    }
    .utility-buttons {
      display: flex;
      gap: 2px;
    }
    .utility-buttons .el-button,
    .action-buttons .el-button {
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    .utility-buttons .el-button {
      color: #fff;
      border-color: #dcdcdc;
    }
    .utility-buttons .filter-btn {
      background-color: #9B59B6;
    }
    .utility-buttons .import-btn {
      background-color: #1ABC9C;
    }
    .utility-buttons .export-btn {
      background-color: #F1C40F;
    }
    .utility-buttons .add-batch-btn {
      background-color: #20B2AA;
    }
    .utility-buttons .el-button:hover {
      opacity: 0.9;
    }
    .action-buttons {
      display: flex;
      flex-direction: row-reverse;
      gap: 2px;
    }
    .action-buttons .el-button {
      color: #fff;
      border-color: transparent;
    }
    .action-buttons .add-btn {
      background-color: #409EFF;
    }
    .action-buttons .edit-btn {
      background-color: #E6A23C;
    }
    .action-buttons .delete-btn {
      background-color: #F56C6C;
    }
    .action-buttons .save-btn {
      background-color: #67C23A;
    }
    .action-buttons .withdraw-btn {
      background-color: #E91E63;
    }
    .action-buttons .print-btn {
      background-color: #7F8C8D;
    }
    .action-buttons .el-button:hover {
      opacity: 0.9;
    }
    .form-section {
      background: #fff;
      padding: 20px;
      border-radius: 4px;
      margin-bottom: 10px;
      flex-shrink: 0; /* Prevent shrinking */
    }
    .table-section {
      background: #fff;
      padding: 20px;
      border-radius: 4px;
      flex: 1 0 auto; /* Allow growth based on content */
    }
    @media print {
      .wrapper, .sidebar, .operation-bar, .el-tabs { display: none; }
      .table-section { display: block !important; }
    }
    @media (max-width: 1366px) {
      .el-col { width: 50% !important; }
      .el-col:nth-child(3n) { width: 100% !important; }
      .utility-buttons {
        flex-wrap: wrap;
        gap: 2px;
      }
      .action-buttons {
        flex-wrap: wrap;
        gap: 2px;
      }
    }
    .sub-category-row {
      margin-top: 10px;
      border: 1px solid #dcdcdc;
      padding: 10px;
      border-radius: 4px;
    }
    .category-group {
      margin-bottom: 20px;
    }
    .category-group-header {
      background: #f5f7fa;
      padding: 10px;
      font-weight: bold;
      border-bottom: 1px solid #dcdcdc;
    }
    .batch-price-controls {
      margin: 10px 0;
      padding: 10px;
      background: #f5f7fa;
      border-radius: 4px;
    }
    .el-table {
      width: 100%; /* Allow table to expand naturally */
    }
    .no-categories-message {
      padding: 10px;
      background: #fff;
      border: 1px solid #dcdcdc;
      border-radius: 4px;
      color: #f56c6c;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="app" class="wrapper">
    <div class="main-content">
      <div class="sidebar">
        <el-menu :default-active="activeSidebar" class="sidebar-menu" @select="handleSidebarSelect">
          <el-menu-item index="1">供应商管理</el-menu-item>
          <el-menu-item index="2">客户管理</el-menu-item>
          <el-menu-item index="3">柜台管理</el-menu-item>
          <el-menu-item index="4">员工管理</el-menu-item>
          <el-menu-item index="5">用户管理</el-menu-item>
          <el-menu-item index="6">产品类目</el-menu-item>
          <el-menu-item index="7">销售模板</el-menu-item>
          <el-menu-item index="8">标签模板</el-menu-item>
        </el-menu>
      </div>
      <div class="content-box">
        <el-tabs v-model="activeTab" type="card">
          <!-- 供应商管理 -->
          <el-tab-pane label="供应商管理" name="suppliers">
            <div class="content" v-if="activeTab === 'suppliers'">
              <div class="operation-bar">
                <div style="display: flex; align-items: center;">
                  <div class="pagination-buttons">
                    <img src="material/Page 1.png" alt="第一页" :class="{ gray: currentPage === 1 }" @click="goToFirstPage">
                    <img src="material/Previous Page.png" alt="上一页" :class="{ gray: currentPage === 1 }" @click="goToPreviousPage">
                    <img src="material/Next Page.png" alt="下一页" :class="{ gray: currentPage === totalPages }" @click="goToNextPage">
                    <img src="material/Last Page.png" alt="最后一页" :class="{ gray: currentPage === totalPages }" @click="goToLastPage">
                  </div>
                  <div class="utility-buttons">
                    <el-button type="default" size="small" icon="el-icon-search" class="filter-btn" @click="filter">筛选</el-button>
                    <el-button type="default" size="small" icon="el-icon-upload" class="import-btn" @click="importData">导入</el-button>
                    <el-button type="default" size="small" icon="el-icon-download" class="export-btn" @click="exportData">导出</el-button>
                  </div>
                </div>
                <div class="action-buttons">
                  <el-button type="default" size="small" icon="el-icon-printer" class="print-btn" @click="print">打印</el-button>
                  <el-button type="default" size="small" class="withdraw-btn" @click="withdraw">撤回</el-button>
                  <el-button type="default" size="small" class="save-btn" @click="saveSupplier">保存</el-button>
                  <el-button type="default" size="small" class="delete-btn" @click="deleteSupplier">删除</el-button>
                  <el-button type="default" size="small" class="edit-btn" @click="editSupplier">修改</el-button>
                  <el-button type="default" size="small" class="add-btn" @click="addSupplier">新建</el-button>
                </div>
              </div>
              <div class="form-section" v-if="showSupplierForm">
                <el-form :model="supplierForm" :rules="supplierRules" ref="supplierForm" label-width="100px">
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="代码" prop="code">
                        <el-input v-model="supplierForm.code"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="简称" prop="short_name">
                        <el-input v-model="supplierForm.short_name"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="全称" prop="full_name">
                        <el-input v-model="supplierForm.full_name"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="税号" prop="tax_id">
                        <el-input v-model="supplierForm.tax_id"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="法人" prop="legal_person">
                        <el-input v-model="supplierForm.legal_person"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="联系人" prop="contact">
                        <el-input v-model="supplierForm.contact"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="电话" prop="phone">
                        <el-input v-model="supplierForm.phone"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="微信" prop="wechat">
                        <el-input v-model="supplierForm.wechat"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </el-form>
              </div>
              <div class="table-section">
                <el-table :data="suppliers" border style="width: 100%;" @selection-change="handleSelectionChange">
                  <el-table-column type="selection" width="55"></el-table-column>
                  <el-table-column prop="code" label="代码"></el-table-column>
                  <el-table-column prop="short_name" label="简称"></el-table-column>
                  <el-table-column prop="full_name" label="全称"></el-table-column>
                  <el-table-column prop="tax_id" label="税号"></el-table-column>
                  <el-table-column prop="legal_person" label="法人"></el-table-column>
                  <el-table-column prop="contact" label="联系人"></el-table-column>
                  <el-table-column prop="phone" label="电话"></el-table-column>
                  <el-table-column prop="wechat" label="微信"></el-table-column>
                </el-table>
              </div>
            </div>
          </el-tab-pane>
          <!-- 客户管理 -->
          <el-tab-pane label="客户管理" name="customers">
            <div class="content" v-if="activeTab === 'customers'">
              <div class="operation-bar">
                <div style="display: flex; align-items: center;">
                  <div class="pagination-buttons">
                    <img src="material/Page 1.png" alt="第一页" :class="{ gray: currentPage === 1 }" @click="goToFirstPage">
                    <img src="material/Previous Page.png" alt="上一页" :class="{ gray: currentPage === 1 }" @click="goToPreviousPage">
                    <img src="material/Next Page.png" alt="下一页" :class="{ gray: currentPage === totalPages }" @click="goToNextPage">
                    <img src="material/Last Page.png" alt="最后一页" :class="{ gray: currentPage === totalPages }" @click="goToLastPage">
                  </div>
                  <div class="utility-buttons">
                    <el-button type="default" size="small" icon="el-icon-search" class="filter-btn" @click="filter">筛选</el-button>
                    <el-button type="default" size="small" icon="el-icon-upload" class="import-btn" @click="importData">导入</el-button>
                    <el-button type="default" size="small" icon="el-icon-download" class="export-btn" @click="exportData">导出</el-button>
                  </div>
                </div>
                <div class="action-buttons">
                  <el-button type="default" size="small" icon="el-icon-printer" class="print-btn" @click="print">打印</el-button>
                  <el-button type="default" size="small" class="withdraw-btn" @click="withdraw">撤回</el-button>
                  <el-button type="default" size="small" class="save-btn" @click="saveCustomer">保存</el-button>
                  <el-button type="default" size="small" class="delete-btn" @click="deleteCustomer">删除</el-button>
                  <el-button type="default" size="small" class="edit-btn" @click="editCustomer">修改</el-button>
                  <el-button type="default" size="small" class="add-btn" @click="addCustomer">新建</el-button>
                </div>
              </div>
              <div class="form-section" v-if="showCustomerForm">
                <el-form :model="customerForm" :rules="customerRules" ref="customerForm" label-width="100px">
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="代码" prop="code">
                        <el-input v-model="customerForm.code"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="简称" prop="short_name">
                        <el-input v-model="customerForm.short_name"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="全称" prop="full_name">
                        <el-input v-model="customerForm.full_name"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="税号" prop="tax_id">
                        <el-input v-model="customerForm.tax_id"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="法人" prop="legal_person">
                        <el-input v-model="customerForm.legal_person"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="联系人" prop="contact">
                        <el-input v-model="customerForm.contact"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="电话" prop="phone">
                        <el-input v-model="customerForm.phone"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="微信" prop="wechat">
                        <el-input v-model="customerForm.wechat"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="销售模板绑定" prop="sales_template_id">
                        <el-select v-model="customerForm.sales_template_id" placeholder="请选择销售模板" style="width: 100%;">
                          <el-option
                            v-for="template in salesTemplates"
                            :key="template.id"
                            :label="template.template_name"
                            :value="template.id"
                          ></el-option>
                        </el-select>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </el-form>
              </div>
              <div class="table-section">
                <el-table :data="customers" border style="width: 100%;" @selection-change="handleSelectionChange">
                  <el-table-column type="selection" width="55"></el-table-column>
                  <el-table-column prop="code" label="代码"></el-table-column>
                  <el-table-column prop="short_name" label="简称"></el-table-column>
                  <el-table-column prop="full_name" label="全称"></el-table-column>
                  <el-table-column prop="tax_id" label="税号"></el-table-column>
                  <el-table-column prop="legal_person" label="法人"></el-table-column>
                  <el-table-column prop="contact" label="联系人"></el-table-column>
                  <el-table-column prop="phone" label="电话"></el-table-column>
                  <el-table-column prop="wechat" label="微信"></el-table-column>
                  <el-table-column prop="sales_template_name" label="销售模板绑定"></el-table-column>
                </el-table>
              </div>
            </div>
          </el-tab-pane>
          <!-- 柜台管理 -->
          <el-tab-pane label="柜台管理" name="counters">
            <div class="content" v-if="activeTab === 'counters'">
              <div class="operation-bar">
                <div style="display: flex; align-items: center;">
                  <div class="pagination-buttons">
                    <img src="material/Page 1.png" alt="第一页" :class="{ gray: currentPage === 1 }" @click="goToFirstPage">
                    <img src="material/Previous Page.png" alt="上一页" :class="{ gray: currentPage === 1 }" @click="goToPreviousPage">
                    <img src="material/Next Page.png" alt="下一页" :class="{ gray: currentPage === totalPages }" @click="goToNextPage">
                    <img src="material/Last Page.png" alt="最后一页" :class="{ gray: currentPage === totalPages }" @click="goToLastPage">
                  </div>
                  <div class="utility-buttons">
                    <el-button type="default" size="small" icon="el-icon-search" class="filter-btn" @click="filter">筛选</el-button>
                    <el-button type="default" size="small" icon="el-icon-upload" class="import-btn" @click="importData">导入</el-button>
                    <el-button type="default" size="small" icon="el-icon-download" class="export-btn" @click="exportData">导出</el-button>
                  </div>
                </div>
                <div class="action-buttons">
                  <el-button type="default" size="small" icon="el-icon-printer" class="print-btn" @click="print">打印</el-button>
                  <el-button type="default" size="small" class="withdraw-btn" @click="withdraw">撤回</el-button>
                  <el-button type="default" size="small" class="save-btn" @click="saveCounter">保存</el-button>
                  <el-button type="default" size="small" class="delete-btn" @click="deleteCounter">删除</el-button>
                  <el-button type="default" size="small" class="edit-btn" @click="editCounter">修改</el-button>
                  <el-button type="default" size="small" class="add-btn" @click="addCounter">新建</el-button>
                </div>
              </div>
              <div class="form-section" v-if="showCounterForm">
                <el-form :model="counterForm" :rules="counterRules" ref="counterForm" label-width="100px">
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="代码" prop="code">
                        <el-input v-model="counterForm.code"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="柜台名称" prop="name">
                        <el-input v-model="counterForm.name"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="描述">
                        <el-input v-model="counterForm.description"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </el-form>
              </div>
              <div class="table-section">
                <el-table :data="counters" border style="width: 100%;" @selection-change="handleSelectionChange">
                  <el-table-column type="selection" width="55"></el-table-column>
                  <el-table-column prop="code" label="代码"></el-table-column>
                  <el-table-column prop="name" label="柜台名称"></el-table-column>
                  <el-table-column prop="description" label="描述"></el-table-column>
                </el-table>
              </div>
            </div>
          </el-tab-pane>
          <!-- 员工管理 -->
          <el-tab-pane label="员工管理" name="staff">
            <div class="content" v-if="activeTab === 'staff'">
              <div class="operation-bar">
                <div style="display: flex; align-items: center;">
                  <div class="pagination-buttons">
                    <img src="material/Page 1.png" alt="第一页" :class="{ gray: currentPage === 1 }" @click="goToFirstPage">
                    <img src="material/Previous Page.png" alt="上一页" :class="{ gray: currentPage === 1 }" @click="goToPreviousPage">
                    <img src="material/Next Page.png" alt="下一页" :class="{ gray: currentPage === totalPages }" @click="goToNextPage">
                    <img src="material/Last Page.png" alt="最后一页" :class="{ gray: currentPage === totalPages }" @click="goToLastPage">
                  </div>
                  <div class="utility-buttons">
                    <el-button type="default" size="small" icon="el-icon-search" class="filter-btn" @click="filter">筛选</el-button>
                    <el-button type="default" size="small" icon="el-icon-upload" class="import-btn" @click="importData">导入</el-button>
                    <el-button type="default" size="small" icon="el-icon-download" class="export-btn" @click="exportData">导出</el-button>
                  </div>
                </div>
                <div class="action-buttons">
                  <el-button type="default" size="small" icon="el-icon-printer" class="print-btn" @click="print">打印</el-button>
                  <el-button type="default" size="small" class="withdraw-btn" @click="withdraw">撤回</el-button>
                  <el-button type="default" size="small" class="save-btn" @click="saveStaff">保存</el-button>
                  <el-button type="default" size="small" class="delete-btn" @click="deleteStaff">删除</el-button>
                  <el-button type="default" size="small" class="edit-btn" @click="editStaff">修改</el-button>
                  <el-button type="default" size="small" class="add-btn" @click="addStaff">新建</el-button>
                </div>
              </div>
              <div class="form-section" v-if="showStaffForm">
                <el-form :model="staffForm" :rules="staffRules" ref="staffForm" label-width="100px">
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="代码" prop="code">
                        <el-input v-model="staffForm.code"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="姓名" prop="name">
                        <el-input v-model="staffForm.name"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="身份证" prop="id_number">
                        <el-input v-model="staffForm.id_number"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="手机号" prop="phone">
                        <el-input v-model="staffForm.phone"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="身份证地址" prop="id_address">
                        <el-input v-model="staffForm.id_address"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="联系地址" prop="contact_address">
                        <el-input v-model="staffForm.contact_address"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="学历" prop="education">
                        <el-input v-model="staffForm.education"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="毕业学校" prop="school">
                        <el-input v-model="staffForm.school"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </el-form>
              </div>
              <div class="table-section">
                <el-table :data="staff" border style="width: 100%;" @selection-change="handleSelectionChange">
                  <el-table-column type="selection" width="55"></el-table-column>
                  <el-table-column prop="code" label="代码"></el-table-column>
                  <el-table-column prop="name" label="姓名"></el-table-column>
                  <el-table-column prop="id_number" label="身份证"></el-table-column>
                  <el-table-column prop="phone" label="手机号"></el-table-column>
                  <el-table-column prop="id_address" label="身份证地址"></el-table-column>
                  <el-table-column prop="contact_address" label="联系地址"></el-table-column>
                  <el-table-column prop="education" label="学历"></el-table-column>
                  <el-table-column prop="school" label="毕业学校"></el-table-column>
                </el-table>
              </div>
            </div>
          </el-tab-pane>
          <!-- 用户管理 -->
          <el-tab-pane label="用户管理" name="users">
            <div class="content" v-if="activeTab === 'users'">
              <div class="operation-bar">
                <div style="display: flex; align-items: center;">
                  <div class="pagination-buttons">
                    <img src="material/Page 1.png" alt="第一页" :class="{ gray: currentPage === 1 }" @click="goToFirstPage">
                    <img src="material/Previous Page.png" alt="上一页" :class="{ gray: currentPage === 1 }" @click="goToPreviousPage">
                    <img src="material/Next Page.png" alt="下一页" :class="{ gray: currentPage === totalPages }" @click="goToNextPage">
                    <img src="material/Last Page.png" alt="最后一页" :class="{ gray: currentPage === totalPages }" @click="goToLastPage">
                  </div>
                  <div class="utility-buttons">
                    <el-button type="default" size="small" icon="el-icon-search" class="filter-btn" @click="filter">筛选</el-button>
                    <el-button type="default" size="small" icon="el-icon-upload" class="import-btn" @click="importData">导入</el-button>
                    <el-button type="default" size="small" icon="el-icon-download" class="export-btn" @click="exportData">导出</el-button>
                  </div>
                </div>
                <div class="action-buttons">
                  <el-button type="default" size="small" icon="el-icon-printer" class="print-btn" @click="print">打印</el-button>
                  <el-button type="default" size="small" class="withdraw-btn" @click="withdraw">撤回</el-button>
                  <el-button type="default" size="small" class="save-btn" @click="saveUser">保存</el-button>
                  <el-button type="default" size="small" class="delete-btn" @click="deleteUser">删除</el-button>
                  <el-button type="default" size="small" class="edit-btn" @click="editUser">修改</el-button>
                  <el-button type="default" size="small" class="add-btn" @click="addUser">新建</el-button>
                </div>
              </div>
              <div class="form-section" v-if="showUserForm">
                <el-form :model="userForm" :rules="userRules" ref="userForm" label-width="100px">
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="用户名" prop="username">
                        <el-input v-model="userForm.username"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="密码" prop="password">
                        <el-input v-model="userForm.password" type="password"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="角色" prop="role">
                        <el-select v-model="userForm.role" placeholder="请选择角色">
                          <el-option label="管理员" value="admin"></el-option>
                          <el-option label="普通用户" value="user"></el-option>
                        </el-select>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="姓名" prop="name">
                        <el-input v-model="userForm.name"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </el-form>
              </div>
              <div class="table-section">
                <el-table :data="users" border style="width: 100%;" @selection-change="handleSelectionChange">
                  <el-table-column type="selection" width="55"></el-table-column>
                  <el-table-column prop="username" label="用户名"></el-table-column>
                  <el-table-column prop="role" label="角色"></el-table-column>
                  <el-table-column prop="name" label="姓名"></el-table-column>
                </el-table>
              </div>
            </div>
          </el-tab-pane>
          <!-- 产品类目 -->
          <el-tab-pane label="产品类目" name="categories">
            <div class="content" v-if="activeTab === 'categories'">
              <div class="operation-bar">
                <div style="display: flex; align-items: center;">
                  <div class="pagination-buttons">
                    <img src="material/Page 1.png" alt="第一页" :class="{ gray: currentPage === 1 }" @click="goToFirstPage">
                    <img src="material/Previous Page.png" alt="上一页" :class="{ gray: currentPage === 1 }" @click="goToPreviousPage">
                    <img src="material/Next Page.png" alt="下一页" :class="{ gray: currentPage === totalPages }" @click="goToNextPage">
                    <img src="material/Last Page.png" alt="最后一页" :class="{ gray: currentPage === totalPages }" @click="goToLastPage">
                  </div>
                  <div class="utility-buttons">
                    <el-button type="default" size="small" icon="el-icon-search" class="filter-btn" @click="filter">筛选</el-button>
                    <el-button type="default" size="small" icon="el-icon-upload" class="import-btn" @click="importData">导入</el-button>
                    <el-button type="default" size="small" icon="el-icon-download" class="export-btn" @click="exportData">导出</el-button>
                    <el-button type="default" size="small" class="add-batch-btn" @click="showBatchSubCategoryForm">批量添加子分类</el-button>
                  </div>
                </div>
                <div class="action-buttons">
                  <el-button type="default" size="small" icon="el-icon-printer" class="print-btn" @click="print">打印</el-button>
                  <el-button type="default" size="small" class="withdraw-btn" @click="withdraw">撤回</el-button>
                  <el-button type="default" size="small" class="save-btn" @click="saveCategory">保存</el-button>
                  <el-button type="default" size="small" class="delete-btn" @click="deleteCategory">删除</el-button>
                  <el-button type="default" size="small" class="edit-btn" @click="editCategory">修改</el-button>
                  <el-button type="default" size="small" class="add-btn" @click="addCategory">新建父类</el-button>
                </div>
              </div>
              <div class="form-section" v-if="showCategoryForm">
                <el-form :model="categoryForm" :rules="categoryRules" ref="categoryForm" label-width="100px">
                  <el-row :gutter="20">
                    <el-col :span="12">
                      <el-form-item label="类目名称（父类）" prop="name">
                        <el-input v-model="categoryForm.name"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                  <el-row :gutter="20">
                    <el-col :span="24">
                      <el-form-item label="描述">
                        <el-input v-model="categoryForm.description" type="textarea"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </el-form>
              </div>
              <el-dialog title="批量添加子分类" :visible.sync="showSubCategoryForm" width="70%">
                <el-form :model="subCategoryForm" ref="subCategoryForm" label-width="100px">
                  <el-form-item label="父类目" prop="parent_id" :rules="{ required: true, message: '请选择父类目', trigger: 'change' }">
                    <el-select v-model="subCategoryForm.parent_id" placeholder="请选择父类目" style="width: 100%;">
                      <el-option v-for="item in topLevelCategoriesComputed" :key="item.id" :label="item.name" :value="item.id"></el-option>
                    </el-select>
                  </el-form-item>
                  <el-form-item label="子分类">
                    <el-button type="primary" size="small" @click="addSubCategory">添加子分类</el-button>
                    <div v-for="(sub, index) in subCategoryForm.subCategories" :key="index" class="sub-category-row">
                      <el-row :gutter="20">
                        <el-col :span="7">
                          <el-form-item :label="`子分类${index + 1}代码`" :prop="'subCategories.' + index + '.code'" :rules="{ required: true, message: '请输入子分类代码', trigger: 'blur' }">
                            <el-input v-model="sub.code"></el-input>
                          </el-form-item>
                        </el-col>
                        <el-col :span="7">
                          <el-form-item :label="`子分类${index + 1}名称`" :prop="'subCategories.' + index + '.name'" :rules="{ required: true, message: '请输入子分类名称', trigger: 'blur' }">
                            <el-input v-model="sub.name"></el-input>
                          </el-form-item>
                        </el-col>
                        <el-col :span="7">
                          <el-form-item :label="`子分类${index + 1}描述`" :prop="'subCategories.' + index + '.description'">
                            <el-input v-model="sub.description"></el-input>
                          </el-form-item>
                        </el-col>
                        <el-col :span="3">
                          <el-button type="danger" size="small" @click="removeSubCategory(index)">删除</el-button>
                        </el-col>
                      </el-row>
                    </div>
                  </el-form-item>
                </el-form>
                <span slot="footer" class="dialog-footer">
                  <el-button @click="showSubCategoryForm = false">取 消</el-button>
                  <el-button type="primary" @click="saveSubCategories">确 定</el-button>
                </span>
              </el-dialog>
              <div class="table-section">
                <el-tree
                  :data="categoriesTree"
                  :props="{ children: 'children', label: 'name' }"
                  node-key="id"
                  default-expand-all
                  draggable
                  @node-drag-end="handleDragEnd"
                  @node-click="handleNodeClick"
                ></el-tree>
              </div>
            </div>
          </el-tab-pane>
          <!-- 销售模板 -->
          <el-tab-pane label="销售模板" name="salesTemplates">
            <div class="content" v-if="activeTab === 'salesTemplates'">
              <div class="operation-bar">
                <div style="display: flex; align-items: center;">
                  <div class="pagination-buttons">
                    <img src="material/Page 1.png" alt="第一页" :class="{ gray: currentPage === 1 }" @click="goToFirstPage">
                    <img src="material/Previous Page.png" alt="上一页" :class="{ gray: currentPage === 1 }" @click="goToPreviousPage">
                    <img src="material/Next Page.png" alt="下一页" :class="{ gray: currentPage === totalPages }" @click="goToNextPage">
                    <img src="material/Last Page.png" alt="最后一页" :class="{ gray: currentPage === totalPages }" @click="goToLastPage">
                  </div>
                  <div class="utility-buttons">
                    <el-button type="default" size="small" icon="el-icon-search" class="filter-btn" @click="filter">筛选</el-button>
                    <el-button type="default" size="small" icon="el-icon-upload" class="import-btn" @click="importData">导入</el-button>
                    <el-button type="default" size="small" icon="el-icon-download" class="export-btn" @click="exportData">导出</el-button>
                  </div>
                </div>
                <div class="action-buttons">
                  <el-button type="default" size="small" icon="el-icon-printer" class="print-btn" @click="print">打印</el-button>
                  <el-button type="default" size="small" class="withdraw-btn" @click="withdraw">撤回</el-button>
                  <el-button type="default" size="small" class="save-btn" @click="saveSalesTemplate">保存</el-button>
                  <el-button type="default" size="small" class="delete-btn" @click="deleteSalesTemplate">删除</el-button>
                  <el-button type="default" size="small" class="edit-btn" @click="editSalesTemplate">修改</el-button>
                  <el-button type="default" size="small" class="add-btn" @click="addSalesTemplate">新建</el-button>
                </div>
              </div>
              <div class="form-section" v-if="categoriesLoaded">
                <el-form :model="salesTemplateForm" ref="salesTemplateForm" label-width="100px">
                  <el-row :gutter="20">
                    <el-col :span="24">
                      <!-- 模板名称 -->
                      <el-form-item label="模板名称" prop="templateName" :rules="{ required: true, message: '请输入模板名称', trigger: 'blur' }">
                        <el-input v-model="salesTemplateForm.templateName" placeholder="如：VIP客户模板"></el-input>
                      </el-form-item>
                      <!-- 批量价格填充 -->
                      <el-col :span="24" class="batch-price-controls">
                        <el-form-item label="批量填充价格">
                          <el-row :gutter="10">
                            <el-col :span="5">
                              <el-input v-model.number="batchLaborCost" placeholder="工费"></el-input>
                            </el-col>
                            <el-col :span="5">
                              <el-input v-model.number="batchExtraFee" placeholder="附加费"></el-input>
                            </el-col>
                            <el-col :span="5">
                              <el-input v-model.number="batchInlayLaborCost" placeholder="镶嵌工费"></el-input>
                            </el-col>
                            <el-col :span="5">
                              <el-input v-model.number="batchStonePrice" placeholder="石价"></el-input>
                            </el-col>
                            <el-col :span="4">
                              <el-button type="primary" size="small" @click="applyBatchPrices">应用</el-button>
                            </el-col>
                          </el-row>
                        </el-form-item>
                      </el-col>
                      <!-- 按父类分组显示子分类 -->
                      <div v-if="topLevelCategoriesComputed.length === 0" class="no-categories-message">
                        <p>暂无产品类目，请先在“产品类目”选项卡中添加父类和子分类。</p>
                      </div>
                      <div v-else>
                        <div v-for="parent in topLevelCategoriesComputed" :key="'parent-' + parent.id.toString()" class="category-group">
                          <div class="category-group-header">
                            {{ parent.name }} (父类 ID: {{ parent.id }})
                          </div>
                          <el-table
                            :data="getSubCategoriesForParent(parent.id)"
                            border
                            style="width: 100%;"
                            @selection-change="(val) => handleSalesTemplateSelectionChange(val, parent.id)"
                            :ref="'subCategoryTable_' + parent.id"
                            :row-key="row => row.id"
                          >
                            <el-table-column type="selection" width="55" :reserve-selection="true"></el-table-column>
                            <el-table-column prop="name" label="子分类"></el-table-column>
                            <el-table-column label="工费">
                              <template slot-scope="scope">
                                <el-input v-model.number="scope.row.labor_cost" type="number" placeholder="工费"></el-input>
                              </template>
                            </el-table-column>
                            <el-table-column label="附加费">
                              <template slot-scope="scope">
                                <el-input v-model.number="scope.row.extra_fee" type="number" placeholder="附加费"></el-input>
                              </template>
                            </el-table-column>
                            <el-table-column label="镶嵌工费">
                              <template slot-scope="scope">
                                <el-input v-model.number="scope.row.inlay_labor_cost" type="number" placeholder="镶嵌工费"></el-input>
                              </template>
                            </el-table-column>
                            <el-table-column label="石价">
                              <template slot-scope="scope">
                                <el-input v-model.number="scope.row.stone_price" type="number" placeholder="石价"></el-input>
                              </template>
                            </el-table-column>
                          </el-table>
                        </div>
                      </div>
                    </el-col>
                  </el-row>
                </el-form>
              </div>
              <div class="table-section">
                <el-table :data="salesTemplates" border style="width: 100%;" @selection-change="handleSelectionChange">
                  <el-table-column type="selection" width="55"></el-table-column>
                  <el-table-column prop="template_name" label="模板名称"></el-table-column>
                </el-table>
              </div>
            </div>
          </el-tab-pane>
          <!-- 标签模板 -->
          <el-tab-pane label="标签模板" name="labelTemplates">
            <div class="content" v-if="activeTab === 'labelTemplates'">
              <div class="operation-bar">
                <div style="display: flex; align-items: center;">
                  <div class="pagination-buttons">
                    <img src="material/Page 1.png" alt="第一页" :class="{ gray: currentPage === 1 }" @click="goToFirstPage">
                    <img src="material/Previous Page.png" alt="上一页" :class="{ gray: currentPage === 1 }" @click="goToPreviousPage">
                    <img src="material/Next Page.png" alt="下一页" :class="{ gray: currentPage === totalPages }" @click="goToNextPage">
                    <img src="material/Last Page.png" alt="最后一页" :class="{ gray: currentPage === totalPages }" @click="goToLastPage">
                  </div>
                  <div class="utility-buttons">
                    <el-button type="default" size="small" icon="el-icon-search" class="filter-btn" @click="filter">筛选</el-button>
                    <el-button type="default" size="small" icon="el-icon-upload" class="import-btn" @click="importData">导入</el-button>
                    <el-button type="default" size="small" icon="el-icon-download" class="export-btn" @click="exportData">导出</el-button>
                  </div>
                </div>
                <div class="action-buttons">
                  <el-button type="default" size="small" icon="el-icon-printer" class="print-btn" @click="print">打印</el-button>
                  <el-button type="default" size="small" class="withdraw-btn" @click="withdraw">撤回</el-button>
                  <el-button type="default" size="small" class="save-btn" @click="saveLabelTemplate">保存</el-button>
                  <el-button type="default" size="small" class="delete-btn" @click="deleteLabelTemplate">删除</el-button>
                  <el-button type="default" size="small" class="edit-btn" @click="editLabelTemplate">修改</el-button>
                  <el-button type="default" size="small" class="add-btn" @click="addLabelTemplate">新建</el-button>
                </div>
              </div>
              <div class="form-section" v-if="showLabelTemplateForm">
                <el-form :model="labelTemplateForm" :rules="labelTemplateRules" ref="labelTemplateForm" label-width="100px">
                  <el-row :gutter="20">
                    <el-col :span="8">
                      <el-form-item label="条码位置">
                        <el-input v-model="labelTemplateForm.barcode_position"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="金重">
                        <el-input v-model.number="labelTemplateForm.gold_weight" type="number"></el-input>
                      </el-form-item>
                    </el-col>
                    <el-col :span="8">
                      <el-form-item label="标准">
                        <el-input v-model="labelTemplateForm.standard"></el-input>
                      </el-form-item>
                    </el-col>
                  </el-row>
                </el-form>
              </div>
              <div class="table-section">
                <el-table :data="labelTemplates" border style="width: 100%;" @selection-change="handleSelectionChange">
                  <el-table-column type="selection" width="55"></el-table-column>
                  <el-table-column prop="barcode_position" label="条码位置"></el-table-column>
                  <el-table-column prop="gold_weight" label="金重"></el-table-column>
                  <el-table-column prop="standard" label="标准"></el-table-column>
                </el-table>
              </div>
            </div>
          </el-tab-pane>
        </el-tabs>
      </div>
    </div>
  </div>

  <script>
    new Vue({
      el: '#app',
      data() {
        return {
          loading: false,
          categoriesLoaded: false,
          activeSidebar: '1',
          activeTab: 'suppliers',
          suppliers: [],
          customers: [],
          counters: [],
          staff: [],
          users: [],
          categories: [],
          topLevelCategories: [],
          categoriesTree: [],
          salesTemplates: [],
          labelTemplates: [],
          total: 0,
          totalPages: 1,
          currentPage: 1,
          pageSize: 10,
          selectedRows: [],
          showSupplierForm: false,
          showCustomerForm: false,
          showCounterForm: false,
          showStaffForm: false,
          showUserForm: false,
          showCategoryForm: false,
          showSalesTemplateForm: false,
          showLabelTemplateForm: false,
          showSubCategoryForm: false,
          supplierForm: {
            id: null,
            code: '',
            short_name: '',
            full_name: '',
            tax_id: '',
            legal_person: '',
            contact: '',
            phone: '',
            wechat: ''
          },
          customerForm: {
            id: null,
            code: '',
            short_name: '',
            full_name: '',
            tax_id: '',
            legal_person: '',
            contact: '',
            phone: '',
            wechat: '',
            sales_template_id: null
          },
          counterForm: {
            id: null,
            code: '',
            name: '',
            description: ''
          },
          staffForm: {
            id: null,
            code: '',
            name: '',
            id_number: '',
            phone: '',
            id_address: '',
            contact_address: '',
            education: '',
            school: ''
          },
          userForm: {
            id: null,
            username: '',
            password: '',
            role: '',
            name: ''
          },
          categoryForm: {
            id: null,
            name: '',
            parent_id: null,
            description: ''
          },
          subCategoryForm: {
            parent_id: null,
            subCategories: []
          },
          salesTemplateForm: {
            templateName: '',
            selectedSubCategories: []
          },
          batchLaborCost: 0,
          batchExtraFee: 0,
          batchInlayLaborCost: 0,
          batchStonePrice: 0,
          subCategoriesForSales: [],
          allSubCategories: [],
          supplierRules: {
            code: [{ required: false, message: '请输入代码', trigger: 'blur' }],
            short_name: [{ required: true, message: '请输入简称', trigger: 'blur' }],
            full_name: [{ required: true, message: '请输入全称', trigger: 'blur' }],
            contact: [{ required: true, message: '请输入联系人', trigger: 'blur' }]
          },
          customerRules: {
            code: [{ required: false, message: '请输入代码', trigger: 'blur' }],
            short_name: [{ required: true, message: '请输入简称', trigger: 'blur' }],
            full_name: [{ required: true, message: '请输入全称', trigger: 'blur' }],
            contact: [{ required: true, message: '请输入联系人', trigger: 'blur' }],
            sales_template_id: [{ required: false, message: '请选择销售模板', trigger: 'change' }]
          },
          counterRules: {
            code: [{ required: true, message: '请输入代码', trigger: 'blur' }],
            name: [{ required: true, message: '请输入柜台名称', trigger: 'blur' }]
          },
          staffRules: {
            code: [{ required: false, message: '请输入代码', trigger: 'blur' }],
            name: [{ required: true, message: '请输入姓名', trigger: 'blur' }],
            id_number: [{ required: true, message: '请输入身份证', trigger: 'blur' }],
            phone: [{ required: true, message: '请输入手机号', trigger: 'blur' }],
            id_address: [{ required: false, message: '请输入身份证地址', trigger: 'blur' }],
            contact_address: [{ required: false, message: '请输入联系地址', trigger: 'blur' }],
            education: [{ required: false, message: '请输入学历', trigger: 'blur' }],
            school: [{ required: false, message: '请输入毕业学校', trigger: 'blur' }]
          },
          userRules: {
            username: [{ required: true, message: '请输入用户名', trigger: 'blur' }],
            password: [{ required: true, message: '请输入密码', trigger: 'blur' }],
            role: [{ required: true, message: '请选择角色', trigger: 'change' }],
            name: [{ required: true, message: '请输入姓名', trigger: 'blur' }]
          },
          categoryRules: {
            name: [{ required: true, message: '请输入类目名称', trigger: 'blur' }]
          },
          salesTemplateRules: {},
          labelTemplateRules: {},
          selectedCategory: null
        };
      },
      computed: {
        topLevelCategoriesComputed() {
          const topLevel = this.categories.filter(category => {
            const parentId = category.parent_id;
            const isTopLevel = parentId === null || parentId === undefined || parentId === 'null' || parentId === '' || parentId === 0;
            return isTopLevel;
          });
          console.log('Computed topLevelCategories:', JSON.stringify(topLevel, null, 2));
          return topLevel;
        }
      },
      methods: {
        // Helper method to check for duplicates
        checkForDuplicates(dataList, form, fields, excludeId = null) {
          for (const item of dataList) {
            // Skip the current record if editing (excludeId is the ID of the record being edited)
            if (excludeId && item.id === excludeId) continue;

            for (const field of fields) {
              const fieldValue = form[field.key];
              if (fieldValue && item[field.key] === fieldValue) {
                return { isDuplicate: true, fieldLabel: field.label, value: fieldValue };
              }
            }
          }
          return { isDuplicate: false };
        },
        async fetchCategories() {
          try {
            const response = await axios.get('/api/categories');
            const newCategories = response.data.data || [];
            const filteredCategories = newCategories.filter(item => item && item.id && item.name);
            console.log('Fetched categories:', JSON.stringify(filteredCategories, null, 2));
            this.$set(this, 'categories', filteredCategories);
            this.updateAllSubCategories();
            this.updateSubCategoriesForSales();
            this.buildTree(this.categories);
            this.categoriesLoaded = true;
            console.log('Categories loaded:', JSON.stringify(this.categories, null, 2));
            console.log('Top-level categories after fetch:', JSON.stringify(this.topLevelCategoriesComputed, null, 2));
            console.log('All subcategories after fetch:', JSON.stringify(this.allSubCategories, null, 2));
            console.log('Subcategories for sales after fetch:', JSON.stringify(this.subCategoriesForSales, null, 2));
          } catch (error) {
            console.error('Fetch categories failed:', error);
            alert('加载产品类目失败：' + (error.response?.data?.message || error.message));
          }
        },
        updateAllSubCategories() {
          const subCategories = this.categories.filter(category => {
            const parentId = category.parent_id;
            const isSubCategory = parentId !== null && parentId !== undefined && parentId !== 'null' && parentId !== '' && parentId !== 0;
            console.log(`Category ${category.name} (ID: ${category.id}) - parent_id: ${parentId}, isSubCategory: ${isSubCategory}`);
            return isSubCategory;
          }).map(sub => ({
            ...sub,
            labor_cost: sub.labor_cost || 0,
            extra_fee: sub.extra_fee || 0,
            inlay_labor_cost: sub.inlay_labor_cost || 0,
            stone_price: sub.stone_price || 0
          }));
          this.$set(this, 'allSubCategories', subCategories);
          console.log('Updated allSubCategories:', JSON.stringify(this.allSubCategories, null, 2));
        },
        updateSubCategoriesForSales() {
          const subCategories = [...this.allSubCategories].map(sub => ({
            ...sub,
            labor_cost: sub.labor_cost || 0,
            extra_fee: sub.extra_fee || 0,
            inlay_labor_cost: sub.inlay_labor_cost || 0,
            stone_price: sub.stone_price || 0
          }));
          this.$set(this, 'subCategoriesForSales', subCategories);
          console.log('Updated subCategoriesForSales:', JSON.stringify(this.subCategoriesForSales, null, 2));
        },
        getSubCategoriesForParent(parentId) {
          const subCategories = this.subCategoriesForSales.filter(sub => {
            const subParentId = sub.parent_id;
            const matches = subParentId === parentId || (subParentId && subParentId.toString() === parentId.toString());
            console.log(`Subcategory ${sub.name} (ID: ${sub.id}) - parent_id: ${subParentId}, matches ${parentId}: ${matches}`);
            return matches;
          });
          console.log(`Subcategories for parent ID ${parentId}:`, JSON.stringify(subCategories, null, 2));
          return subCategories;
        },
        buildTree(data) {
          const map = new Map();
          const roots = [];
          const validData = data.filter(item => item && item.id);
          validData.forEach(item => {
            if (item.id === item.parent_id) {
              console.warn(`Skipping circular reference for item ${item.name} (ID: ${item.id})`);
              roots.push({ ...item, children: [] });
            } else {
              map.set(item.id, { ...item, children: [] });
            }
          });
          validData.forEach(item => {
            if (item.id === item.parent_id) return;
            if (item.parent_id !== null && item.parent_id !== undefined && item.parent_id !== 'null' && item.parent_id !== '' && item.parent_id !== 0) {
              const parent = map.get(item.parent_id);
              if (parent) {
                parent.children.push(map.get(item.id) || item);
              } else {
                console.warn(`Invalid parent_id ${item.parent_id} for item ${item.name}, treating as root`);
                roots.push(map.get(item.id) || item);
              }
            } else {
              roots.push(map.get(item.id) || item);
            }
          });
          this.categoriesTree = roots;
          console.log('Categories tree built:', JSON.stringify(this.categoriesTree, null, 2));
        },
        handleSidebarSelect(index) {
          this.activeSidebar = index;
          const tabMap = {
            '1': 'suppliers',
            '2': 'customers',
            '3': 'counters',
            '4': 'staff',
            '5': 'users',
            '6': 'categories',
            '7': 'salesTemplates',
            '8': 'labelTemplates'
          };
          this.activeTab = tabMap[index] || 'suppliers';
          this.currentPage = 1; // Reset pagination
          this.fetchData();
        },
        goToFirstPage() {
          if (this.currentPage !== 1) {
            this.currentPage = 1;
            this.fetchData();
          }
        },
        goToPreviousPage() {
          if (this.currentPage > 1) {
            this.currentPage--;
            this.fetchData();
          }
        },
        goToNextPage() {
          if (this.currentPage < this.totalPages) {
            this.currentPage++;
            this.fetchData();
          }
        },
        goToLastPage() {
          if (this.currentPage !== this.totalPages) {
            this.currentPage = this.totalPages;
            this.fetchData();
          }
        },
        fetchData() {
          console.log('Fetching data for tab:', this.activeTab);
          if (this.activeTab === 'suppliers') {
            this.fetchSuppliers();
          } else if (this.activeTab === 'customers') {
            this.fetchCustomers();
            this.fetchSalesTemplates();
          } else if (this.activeTab === 'counters') {
            this.fetchCounters();
          } else if (this.activeTab === 'staff') {
            this.fetchStaff();
          } else if (this.activeTab === 'users') {
            this.fetchUsers();
          } else if (this.activeTab === 'categories') {
            this.fetchCategories();
          } else if (this.activeTab === 'salesTemplates') {
            this.fetchSalesTemplates();
          } else if (this.activeTab === 'labelTemplates') {
            this.fetchLabelTemplates();
          }
        },
        fetchSuppliers() {
          axios.get('/api/suppliers', { params: { page: this.currentPage, size: this.pageSize } })
            .then(response => {
              console.log('Suppliers data:', response.data);
              this.suppliers = response.data.data || [];
              this.total = response.data.total || 0;
              this.totalPages = Math.ceil(this.total / this.pageSize) || 1;
            })
            .catch(error => {
              console.error('Fetch suppliers failed:', error);
              alert('加载供应商失败：' + (error.response?.data?.message || error.message));
            });
        },
        fetchCustomers() {
          axios.get('/api/customers', { params: { page: this.currentPage, size: this.pageSize } })
            .then(response => {
              console.log('Customers response:', response.data);
              this.customers = response.data.data.map(customer => ({
                ...customer,
                sales_template_name: this.salesTemplates.find(template => template.id === customer.sales_template_id)?.template_name || '未绑定'
              })) || [];
              this.total = response.data.total || 0;
              this.totalPages = Math.ceil(this.total / this.pageSize) || 1;
            })
            .catch(error => {
              console.error('Fetch customers failed:', error);
              alert('加载客户失败：' + (error.response?.data?.message || error.message));
            });
        },
        fetchCounters() {
          axios.get('/api/counters', { params: { page: this.currentPage, size: this.pageSize } })
            .then(response => {
              console.log('Counters response:', response.data);
              this.counters = response.data.data || [];
              this.total = response.data.total || 0;
              this.totalPages = Math.ceil(this.total / this.pageSize) || 1;
            })
            .catch(error => {
              console.error('Fetch counters failed:', error);
              alert('加载柜台失败：' + (error.response?.data?.message || error.message));
            });
        },
        fetchStaff() {
          axios.get('/api/staff', { params: { page: this.currentPage, size: this.pageSize } })
            .then(response => {
              console.log('Staff response:', response.data);
              this.staff = response.data.data || [];
              this.total = response.data.total || 0;
              this.totalPages = Math.ceil(this.total / this.pageSize) || 1;
            })
            .catch(error => {
              console.error('Fetch staff failed:', error);
              alert('加载员工失败：' + (error.response?.data?.message || error.message));
            });
        },
        fetchUsers() {
          axios.get('/api/users', { params: { page: this.currentPage, size: this.pageSize } })
            .then(response => {
              console.log('Users response:', response.data);
              this.users = response.data.data || [];
              this.total = response.data.total || 0;
              this.totalPages = Math.ceil(this.total / this.pageSize) || 1;
            })
            .catch(error => {
              console.error('Fetch users failed:', error);
              alert('加载用户失败：' + (error.response?.data?.message || error.message));
            });
        },
        fetchSalesTemplates() {
          axios.get('/api/salesTemplates', { params: { page: this.currentPage, size: this.pageSize } })
            .then(response => {
              console.log('Sales templates response:', response.data);
              this.salesTemplates = response.data.data || [];
              this.total = response.data.total || 0;
              this.totalPages = Math.ceil(this.total / this.pageSize) || 1;
              console.log('Updated salesTemplates:', JSON.stringify(this.salesTemplates, null, 2));
              if (this.activeTab === 'customers') {
                this.customers = this.customers.map(customer => ({
                  ...customer,
                  sales_template_name: this.salesTemplates.find(template => template.id === customer.sales_template_id)?.template_name || '未绑定'
                }));
              }
            })
            .catch(error => {
              console.error('Fetch sales templates failed:', error);
              alert('加载销售模板失败：' + (error.response?.data?.message || error.message));
            });
        },
        fetchLabelTemplates() {
          axios.get('/api/labelTemplates', { params: { page: this.currentPage, size: this.pageSize } })
            .then(response => {
              console.log('Label templates response:', response.data);
              this.labelTemplates = response.data.data || [];
              this.total = response.data.total || 0;
              this.totalPages = Math.ceil(this.total / this.pageSize) || 1;
            })
            .catch(error => {
              console.error('Fetch label templates failed:', error);
              alert('加载标签模板失败：' + (error.response?.data?.message || error.message));
            });
        },
        filter() { alert('筛选功能'); },
        importData() { alert('导入功能'); },
        exportData() { alert('导出功能'); },
        withdraw() {
          this.showSupplierForm = false;
          this.showCustomerForm = false;
          this.showCounterForm = false;
          this.showStaffForm = false;
          this.showUserForm = false;
          this.showCategoryForm = false;
          this.showSalesTemplateForm = false;
          this.showLabelTemplateForm = false;
          this.salesTemplateForm = { templateName: '', selectedSubCategories: [] };
          this.subCategoriesForSales = [];
          alert('已回撤');
        },
        print() { window.print(); },
        addSupplier() {
          this.showSupplierForm = true;
          this.supplierForm = {
            id: null,
            code: '',
            short_name: '',
            full_name: '',
            tax_id: '',
            legal_person: '',
            contact: '',
            phone: '',
            wechat: ''
          };
        },
        editSupplier() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          this.showSupplierForm = true;
          this.supplierForm = { ...this.selectedRows[0] };
        },
        deleteSupplier() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          if (confirm('确定删除记录?')) {
            axios.delete(`/api/suppliers/${this.selectedRows[0].id}`).then(() => {
              alert('删除成功');
              this.fetchSuppliers();
            }).catch(error => {
              alert('删除失败：' + (error.response?.data?.message || error.message));
            });
          }
        },
        saveSupplier() {
          this.$refs['supplierForm'].validate((valid) => {
            if (valid) {
              // Check for duplicates before saving
              const fieldsToCheck = [
                { key: 'code', label: '供应商代码' },
                { key: 'short_name', label: '供应商简称' }
              ];
              const duplicateCheck = this.checkForDuplicates(this.suppliers, this.supplierForm, fieldsToCheck, this.supplierForm.id);
              if (duplicateCheck.isDuplicate) {
                alert(`${duplicateCheck.fieldLabel} '${duplicateCheck.value}' 已存在，请使用其他值`);
                return;
              }

              const payload = { ...this.supplierForm };
              const method = this.supplierForm.id ? 'put' : 'post';
              const url = this.supplierForm.id ? `/api/suppliers/${this.supplierForm.id}` : '/api/suppliers';
              axios[method](url, payload).then(response => {
                if (response.status === 200 || response.status === 201) {
                  alert('保存成功');
                  this.showSupplierForm = false;
                  this.fetchSuppliers();
                } else {
                  alert('保存失败：' + (response.data?.message || '未知错误'));
                }
              }).catch(error => {
                // Enhanced error handling for backend duplicate errors
                const errorMessage = error.response?.data?.message || error.message;
                if (error.response?.status === 409 && errorMessage.includes('code')) {
                  alert(`供应商代码 '${this.supplierForm.code}' 已存在，请使用其他代码`);
                } else if (error.response?.status === 409 && errorMessage.includes('short_name')) {
                  alert(`供应商简称 '${this.supplierForm.short_name}' 已存在，请使用其他简称`);
                } else {
                  alert('保存失败：' + errorMessage);
                }
              });
            } else {
              alert('请填写完整信息');
            }
          });
        },
        addCustomer() {
          this.showCustomerForm = true;
          this.customerForm = {
            id: null,
            code: '',
            short_name: '',
            full_name: '',
            tax_id: '',
            legal_person: '',
            contact: '',
            phone: '',
            wechat: '',
            sales_template_id: null
          };
        },
        editCustomer() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          this.showCustomerForm = true;
          this.customerForm = { ...this.selectedRows[0] };
        },
        deleteCustomer() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          if (confirm('确定删除记录?')) {
            axios.delete(`/api/customers/${this.selectedRows[0].id}`).then(() => {
              alert('删除成功');
              this.fetchCustomers();
            }).catch(error => {
              alert('删除失败：' + (error.response?.data?.message || error.message));
            });
          }
        },
        saveCustomer() {
          this.$refs['customerForm'].validate((valid) => {
            if (valid) {
              // Check for duplicates before saving
              const fieldsToCheck = [
                { key: 'code', label: '客户代码' },
                { key: 'short_name', label: '客户简称' }
              ];
              const duplicateCheck = this.checkForDuplicates(this.customers, this.customerForm, fieldsToCheck, this.customerForm.id);
              if (duplicateCheck.isDuplicate) {
                alert(`${duplicateCheck.fieldLabel} '${duplicateCheck.value}' 已存在，请使用其他值`);
                return;
              }

              const payload = { ...this.customerForm };
              const method = this.customerForm.id ? 'put' : 'post';
              const url = this.customerForm.id ? `/api/customers/${this.customerForm.id}` : '/api/customers';
              axios[method](url,payload).then(response => {
                if (response.status === 200 || response.status === 201) {
                  alert('保存成功');
                  this.showCustomerForm = false;
                  this.fetchCustomers();
                } else {
                  alert('保存失败：' + (response.data?.message || '未知错误'));
                }
              }).catch(error => {
                // Enhanced error handling for backend duplicate errors
                const errorMessage = error.response?.data?.message || error.message;
                if (error.response?.status === 409 && errorMessage.includes('code')) {
                  alert(`客户代码 '${this.customerForm.code}' 已存在，请使用其他代码`);
                } else if (error.response?.status === 409 && errorMessage.includes('short_name')) {
                  alert(`客户简称 '${this.customerForm.short_name}' 已存在，请使用其他简称`);
                } else {
                  alert('保存失败：' + errorMessage);
                }
              });
            } else {
              alert('请填写完整信息');
            }
          });
        },
        addCounter() {
          this.showCounterForm = true;
          this.counterForm = {
            id: null,
            code: '',
            name: '',
            description: ''
          };
        },
        editCounter() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          this.showCounterForm = true;
          this.counterForm = { ...this.selectedRows[0] };
        },
        deleteCounter() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          if (confirm('确定删除选中的记录?')) {
            const deletePromises = this.selectedRows.map(row =>
              axios.delete(`/api/counters/${row.id}`)
            );
            Promise.all(deletePromises)
              .then(() => {
                alert('删除成功');
                this.fetchCounters();
              })
              .catch(error => {
                alert('删除失败：' + (error.response?.data?.message || error.message));
              });
          }
        },
        saveCounter() {
          this.$refs['counterForm'].validate((valid) => {
            if (valid) {
              // Check for duplicates before saving
              const fieldsToCheck = [
                { key: 'code', label: '柜台代码' },
                { key: 'name', label: '柜台名称' }
              ];
              const duplicateCheck = this.checkForDuplicates(this.counters, this.counterForm, fieldsToCheck, this.counterForm.id);
              if (duplicateCheck.isDuplicate) {
                alert(`${duplicateCheck.fieldLabel} '${duplicateCheck.value}' 已存在，请使用其他值`);
                return;
              }

              const payload = { ...this.counterForm };
              const method = this.counterForm.id ? 'put' : 'post';
              const url = this.counterForm.id ? `/api/counters/${this.counterForm.id}` : '/api/counters';
              axios[method](url, payload).then(response => {
                if (response.status === 200 || response.status === 201) {
                  alert('保存成功');
                  this.showCounterForm = false;
                  this.fetchCounters();
                } else {
                  alert('保存失败：' + (response.data?.message || '未知错误'));
                }
              }).catch(error => {
                const errorMessage = error.response?.data?.message || error.message;
                if (error.response?.status === 409 && errorMessage.includes('code')) {
                  alert(`柜台代码 '${this.counterForm.code}' 已存在，请使用其他代码`);
                } else if (error.response?.status === 409 && errorMessage.includes('name')) {
                  alert(`柜台名称 '${this.counterForm.name}' 已存在，请使用其他名称`);
                } else {
                  alert('保存失败：' + errorMessage);
                }
              });
            } else {
              alert('请填写完整信息');
            }
          });
        },
        addStaff() {
          this.showStaffForm = true;
          this.staffForm = {
            id: null,
            code: '',
            name: '',
            id_number: '',
            phone: '',
            id_address: '',
            contact_address: '',
            education: '',
            school: ''
          };
        },
        editStaff() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          this.showStaffForm = true;
          this.staffForm = { ...this.selectedRows[0] };
        },
        deleteStaff() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          if (confirm('确定删除记录?')) {
            axios.delete(`/api/staff/${this.selectedRows[0].id}`).then(() => {
              alert('删除成功');
              this.fetchStaff();
            }).catch(error => {
              alert('删除失败：' + (error.response?.data?.message || error.message));
            });
          }
        },
        saveStaff() {
          this.$refs['staffForm'].validate((valid) => {
            if (valid) {
              // Check for duplicates before saving
              const fieldsToCheck = [
                { key: 'code', label: '员工代码' },
                { key: 'id_number', label: '身份证号' }
              ];
              const duplicateCheck = this.checkForDuplicates(this.staff, this.staffForm, fieldsToCheck, this.staffForm.id);
              if (duplicateCheck.isDuplicate) {
                alert(`${duplicateCheck.fieldLabel} '${duplicateCheck.value}' 已存在，请使用其他值`);
                return;
              }

              const payload = { ...this.staffForm };
              const method = this.staffForm.id ? 'put' : 'post';
              const url = this.staffForm.id ? `/api/staff/${this.staffForm.id}` : '/api/staff';
              axios[method](url, payload).then(response => {
                if (response.status === 200 || response.status === 201) {
                  alert('保存成功');
                  this.showStaffForm = false;
                  this.fetchStaff();
                } else {
                  alert('保存失败：' + (response.data?.message || '未知错误'));
                }
              }).catch(error => {
                const errorMessage = error.response?.data?.message || error.message;
                if (error.response?.status === 409 && errorMessage.includes('code')) {
                  alert(`员工代码 '${this.staffForm.code}' 已存在，请使用其他代码`);
                } else if (error.response?.status === 409 && errorMessage.includes('id_number')) {
                  alert(`身份证号 '${this.staffForm.id_number}' 已存在，请使用其他身份证号`);
                } else {
                  alert('保存失败：' + errorMessage);
                }
              });
            } else {
              alert('请填写完整信息');
            }
          });
        },
        addUser() {
          this.showUserForm = true;
          this.userForm = {
            id: null,
            username: '',
            password: '',
            role: '',
            name: ''
          };
        },
        editUser() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          this.showUserForm = true;
          this.userForm = { ...this.selectedRows[0], password: '' };
        },
        deleteUser() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          if (confirm('确定删除记录?')) {
            axios.delete(`/api/users/${this.selectedRows[0].id}`).then(() => {
              alert('删除成功');
              this.fetchUsers();
            }).catch(error => {
              alert('删除失败：' + (error.response?.data?.message || error.message));
            });
          }
        },
        saveUser() {
          this.$refs['userForm'].validate((valid) => {
            if (valid) {
              // Check for duplicates before saving
              const fieldsToCheck = [
                { key: 'username', label: '用户名' }
              ];
              const duplicateCheck = this.checkForDuplicates(this.users, this.userForm, fieldsToCheck, this.userForm.id);
              if (duplicateCheck.isDuplicate) {
                alert(`${duplicateCheck.fieldLabel} '${duplicateCheck.value}' 已存在，请使用其他值`);
                return;
              }

              const payload = { ...this.userForm };
              const method = this.userForm.id ? 'put' : 'post';
              const url = this.userForm.id ? `/api/users/${this.userForm.id}` : '/api/users';
              axios[method](url, payload).then(response => {
                if (response.status === 200 || response.status === 201) {
                  alert('保存成功');
                  this.showUserForm = false;
                  this.fetchUsers();
                } else {
                  alert('保存失败：' + (response.data?.message || '未知错误'));
                }
              }).catch(error => {
                const errorMessage = error.response?.data?.message || error.message;
                if (error.response?.status === 409 && errorMessage.includes('username')) {
                  alert(`用户名 '${this.userForm.username}' 已存在，请使用其他用户名`);
                } else {
                  alert('保存失败：' + errorMessage);
                }
              });
            } else {
              alert('请填写完整信息');
            }
          });
        },
        addCategory() {
          this.showCategoryForm = true;
          this.categoryForm = {
            id: null,
            name: '',
            parent_id: null,
            description: ''
          };
        },
        handleNodeClick(data) {
          this.selectedCategory = data;
          this.categoryForm = { ...data };
          this.showCategoryForm = true;
        },
        editCategory() {
          if (!this.selectedCategory) {
            alert('请先选择一个类目');
            return;
          }
          this.showCategoryForm = true;
          this.categoryForm = { ...this.selectedCategory };
        },
        deleteCategory() {
          if (!this.selectedCategory) {
            alert('请先选择一个类目');
            return;
          }
          const hasChildren = this.selectedCategory.children && this.selectedCategory.children.length > 0;
          const confirmMessage = hasChildren
            ? `确定删除类目 "${this.selectedCategory.name}" 及其所有子分类吗？`
            : `确定删除类目 "${this.selectedCategory.name}" 吗？`;
          if (confirm(confirmMessage)) {
            axios.delete(`/api/categories/${this.selectedCategory.id}`)
              .then(() => {
                alert('删除成功');
                this.selectedCategory = null;
                this.fetchCategories();
              })
              .catch(error => {
                alert('删除失败：' + (error.response?.data?.message || error.message));
              });
          }
        },
        saveCategory() {
          this.$refs['categoryForm'].validate((valid) => {
            if (valid) {
              // Check for duplicates before saving (considering parent_id for subcategories)
              const existingCategory = this.categories.find(category => {
                // Skip the current record if editing
                if (this.categoryForm.id && category.id === this.categoryForm.id) return false;
                // Match name and parent_id (null for top-level categories)
                return category.name === this.categoryForm.name &&
                       (category.parent_id === null ? this.categoryForm.parent_id === null : category.parent_id === this.categoryForm.parent_id);
              });
              if (existingCategory) {
                alert(`类目名称 '${this.categoryForm.name}' 在同一级别已存在，请使用其他名称`);
                return;
              }

              const payload = { ...this.categoryForm, parent_id: null };
              const method = this.categoryForm.id ? 'put' : 'post';
              const url = this.categoryForm.id ? `/api/categories/${this.categoryForm.id}` : '/api/categories';
              axios[method](url, payload).then(response => {
                if (response.status === 200 || response.status === 201) {
                  alert('保存成功');
                  this.showCategoryForm = false;
                  this.fetchCategories();
                } else {
                  alert('保存失败：' + (response.data?.message || '未知错误'));
                }
              }).catch(error => {
                const errorMessage = error.response?.data?.message || error.message;
                if (error.response?.status === 409 && errorMessage.includes('name')) {
                  alert(`类目名称 '${this.categoryForm.name}' 在同一级别已存在，请使用其他名称`);
                } else {
                  alert('保存失败：' + errorMessage);
                }
              });
            } else {
              alert('请填写完整信息');
            }
          });
        },
        async showBatchSubCategoryForm() {
          await this.fetchCategories();
          console.log('Fetched categories in showBatchSubCategoryForm:', JSON.stringify(this.categories, null, 2));
          if (this.topLevelCategoriesComputed.length === 0) {
            console.log('No top-level categories found, forcing refresh...');
            await this.fetchCategories();
            if (this.topLevelCategoriesComputed.length === 0) {
              alert('请先添加至少一个父类！当前数据：\n' + JSON.stringify(this.categories, null, 2));
              return;
            }
          }
          this.subCategoryForm = {
            parent_id: this.topLevelCategoriesComputed.length > 0 ? this.topLevelCategoriesComputed[0].id : null,
            subCategories: []
          };
          console.log('Opening batch sub-category form, topLevelCategories:', JSON.stringify(this.topLevelCategoriesComputed, null, 2));
          this.showSubCategoryForm = true;
        },
        addSubCategory() {
          this.subCategoryForm.subCategories.push({ code: '', name: '', description: '' });
        },
        removeSubCategory(index) {
          this.subCategoryForm.subCategories.splice(index, 1);
        },
        saveSubCategories() {
          console.log('Attempting to save subcategories, subCategoryForm:', JSON.stringify(this.subCategoryForm, null, 2));
          this.$refs['subCategoryForm'].validate((valid) => {
            console.log('Form validation result:', valid);
            if (valid) {
              if (!this.subCategoryForm.parent_id) {
                alert('请选择父类目');
                return;
              }
              const parentCategory = this.topLevelCategoriesComputed.find(cat => cat.id === this.subCategoryForm.parent_id);
              if (!parentCategory) {
                alert('请选择一个有效的父类目');
                return;
              }
              // Check for duplicates in subcategories
              for (const sub of this.subCategoryForm.subCategories) {
                const existingSubCategory = this.categories.find(category => {
                  return category.parent_id === this.subCategoryForm.parent_id &&
                         (category.code === sub.code || category.name === sub.name);
                });
                if (existingSubCategory) {
                  if (existingSubCategory.code === sub.code) {
                    alert(`子分类代码 '${sub.code}' 在该父类下已存在，请使用其他代码`);
                    return;
                  }
                  if (existingSubCategory.name === sub.name) {
                    alert(`子分类名称 '${sub.name}' 在该父类下已存在，请使用其他名称`);
                    return;
                  }
                }
              }

              const subCategories = this.subCategoryForm.subCategories.map(sub => ({
                code: sub.code || '',
                name: sub.name || '',
                parent_id: this.subCategoryForm.parent_id,
                description: sub.description || ''
              }));
              console.log('Sending subcategories to backend:', JSON.stringify({ categories: subCategories }, null, 2));
              axios.post('/api/categories/batch', { categories: subCategories })
                .then(response => {
                  console.log('Backend response:', response);
                  if (response.status === 201) {
                    alert('子分类添加成功');
                    this.showSubCategoryForm = false;
                    this.fetchCategories();
                  } else {
                    alert('子分类添加失败：' + (response.data?.message || '未知错误'));
                  }
                })
                .catch(error => {
                  console.error('Error saving subcategories:', error);
                  const errorMessage = error.response?.data?.message || error.message;
                  if (error.response?.status === 409 && errorMessage.includes('code')) {
                    const codeMatch = errorMessage.match(/code '(.+)'/);
                    alert(`子分类代码 '${codeMatch ? codeMatch[1] : ''}' 在该父类下已存在，请使用其他代码`);
                  } else if (error.response?.status === 409 && errorMessage.includes('name')) {
                    const nameMatch = errorMessage.match(/name '(.+)'/);
                    alert(`子分类名称 '${nameMatch ? nameMatch[1] : ''}' 在该父类下已存在，请使用其他名称`);
                  } else {
                    alert('子分类添加失败：' + errorMessage);
                  }
                });
            } else {
              alert('请填写完整信息');
            }
          });
        },
        handleDragEnd(draggingNode, dropNode, dropType) {
          const draggedId = draggingNode.data.id;
          let newParentId = null;
          if (dropType !== 'inner') {
            newParentId = dropNode ? dropNode.data.id : null;
          } else {
            newParentId = dropNode.data.id;
          }
          if (newParentId && !this.topLevelCategoriesComputed.some(cat => cat.id === newParentId)) {
            alert('只能将类目拖动到顶级类目下');
            this.fetchCategories();
            return;
          }
          axios.put(`/api/categories/${draggedId}`, { parent_id: newParentId }).then(() => {
            this.fetchCategories();
          }).catch(error => {
            alert('拖动调整失败：' + (error.response?.data?.message || error.message));
            this.fetchCategories();
          });
        },
        async addSalesTemplate() {
          if (!this.categoriesLoaded) {
            await this.fetchCategories();
          }
          if (this.categories.length === 0) {
            alert('请先在“产品类目”选项卡中添加父类和子分类！');
            return;
          }
          this.$set(this.salesTemplateForm, 'templateName', '');
          this.$set(this.salesTemplateForm, 'selectedSubCategories', []);
          const updatedSubCategories = [...this.allSubCategories].map(sub => ({
            ...sub,
            labor_cost: 0,
            extra_fee: 0,
            inlay_labor_cost: 0,
            stone_price: 0
          }));
          this.$set(this, 'subCategoriesForSales', updatedSubCategories);
          this.showSalesTemplateForm = true;
          setTimeout(() => {
            this.$forceUpdate();
            console.log('Rendering topLevelCategories:', JSON.stringify(this.topLevelCategoriesComputed, null, 2));
            console.log('Rendering allSubCategories:', JSON.stringify(this.allSubCategories, null, 2));
            console.log('Rendering subCategoriesForSales:', JSON.stringify(this.subCategoriesForSales, null, 2));
          }, 100);
        },
        editSalesTemplate() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          const template = this.selectedRows[0];
          const details = template.details || [];
          this.$set(this.salesTemplateForm, 'templateName', template.template_name || '');
          this.$set(this.salesTemplateForm, 'selectedSubCategories', []);
          const updatedSubCategories = [...this.allSubCategories].map(sub => {
            const existingDetail = details.find(d => d.category_id === sub.id);
            return {
              ...sub,
              labor_cost: existingDetail ? existingDetail.labor_cost : 0,
              extra_fee: existingDetail ? existingDetail.extra_fee : 0,
              inlay_labor_cost: existingDetail ? existingDetail.inlay_labor_cost : 0,
              stone_price: existingDetail ? existingDetail.stone_price : 0
            };
          });
          this.$set(this, 'subCategoriesForSales', updatedSubCategories);
          this.$set(this.salesTemplateForm, 'selectedSubCategories', this.subCategoriesForSales.filter(sub => {
            return details.some(d => d.category_id === sub.id);
          }));
          this.showSalesTemplateForm = true;
          setTimeout(() => {
            this.$forceUpdate();
            console.log('Editing sales template, subCategoriesForSales:', JSON.stringify(this.subCategoriesForSales, null, 2));
          }, 100);
        },
        deleteSalesTemplate() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          if (confirm('确定删除记录?')) {
            const deletePromises = this.selectedRows.map(row =>
              axios.delete(`/api/salesTemplates/${row.id}`)
            );
            Promise.all(deletePromises)
              .then(() => {
                alert('删除成功');
                this.fetchSalesTemplates();
              })
              .catch(error => {
                alert('删除失败：' + (error.response?.data?.message || error.message));
              });
          }
        },
        handleSalesTemplateSelectionChange(val, parentId) {
          console.log(`Selection changed for parent ${parentId}, selected items:`, JSON.stringify(val, null, 2));
          const currentSelected = this.salesTemplateForm.selectedSubCategories.filter(sub => {
            return !this.getSubCategoriesForParent(parentId).some(s => s.id === sub.id);
          });
          this.$set(this.salesTemplateForm, 'selectedSubCategories', [...currentSelected, ...val]);
          const updatedSubCategories = this.subCategoriesForSales.map(sub => {
            const selected = this.salesTemplateForm.selectedSubCategories.find(s => s.id === sub.id);
            return {
              ...sub,
              labor_cost: selected ? selected.labor_cost : sub.labor_cost,
              extra_fee: selected ? selected.extra_fee : sub.extra_fee,
              inlay_labor_cost: selected ? selected.inlay_labor_cost : sub.inlay_labor_cost,
              stone_price: selected ? selected.stone_price : sub.stone_price
            };
          });
          this.$set(this, 'subCategoriesForSales', updatedSubCategories);
          console.log('Updated subCategoriesForSales:', JSON.stringify(this.subCategoriesForSales, null, 2));
        },
        applyBatchPrices() {
          const selected = this.salesTemplateForm.selectedSubCategories;
          if (selected.length === 0) {
            alert('请先勾选至少一个子分类');
            return;
          }
          selected.forEach(sub => {
            const subIndex = this.subCategoriesForSales.findIndex(s => s.id === sub.id);
            if (subIndex !== -1) {
              this.$set(this.subCategoriesForSales, subIndex, {
                ...this.subCategoriesForSales[subIndex],
                labor_cost: this.batchLaborCost || 0,
                extra_fee: this.batchExtraFee || 0,
                inlay_labor_cost: this.batchInlayLaborCost || 0,
                stone_price: this.batchStonePrice || 0
              });
            }
          });
          this.$set(this.salesTemplateForm, 'selectedSubCategories', this.salesTemplateForm.selectedSubCategories.map(sub => {
            const updatedSub = this.subCategoriesForSales.find(s => s.id === sub.id);
            return updatedSub || sub;
          }));
          this.batchLaborCost = 0;
          this.batchExtraFee = 0;
          this.batchInlayLaborCost = 0;
          this.batchStonePrice = 0;
          console.log('Applied batch prices, updated subCategoriesForSales:', JSON.stringify(this.subCategoriesForSales, null, 2));
          alert('批量填充价格成功');
        },
        saveSalesTemplate() {
          if (!this.salesTemplateForm.templateName) {
            alert('请填写模板名称');
            return;
          }
          if (this.salesTemplateForm.selectedSubCategories.length === 0) {
            alert('请至少选择一个子分类');
            return;
          }
          const details = this.salesTemplateForm.selectedSubCategories.map(sub => ({
            category_id: sub.id,
            labor_cost: sub.labor_cost || 0,
            extra_fee: sub.extra_fee || 0,
            inlay_labor_cost: sub.inlay_labor_cost || 0,
            stone_price: sub.stone_price || 0
          }));
          const payload = {
            template_name: this.salesTemplateForm.templateName,
            details
          };
          console.log('Saving template:', JSON.stringify(payload, null, 2));
          const method = this.selectedRows.length === 1 ? 'put' : 'post';
          const url = this.selectedRows.length === 1 ? `/api/salesTemplates/${this.selectedRows[0].id}` : '/api/salesTemplates';
          axios[method](url, payload)
            .then(response => {
              if (response.status === 201 || response.status === 200) {
                alert('保存成功');
                this.showSalesTemplateForm = false;
                this.fetchSalesTemplates();
              } else {
                alert('保存失败：' + (response.data?.message || '未知错误'));
              }
            })
            .catch(error => {
              console.error('Error saving sales template:', error);
              alert('保存失败：' + (error.response?.data?.message || error.message));
            });
        },
        addLabelTemplate() {
          this.showLabelTemplateForm = true;
          this.labelTemplateForm = {
            id: null,
            barcode_position: '',
            gold_weight: 0,
            standard: ''
          };
        },
        editLabelTemplate() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          this.showLabelTemplateForm = true;
          this.labelTemplateForm = { ...this.selectedRows[0] };
        },
        deleteLabelTemplate() {
          if (this.selectedRows.length === 0) {
            alert('请先选择一条记录');
            return;
          }
          if (confirm('确定删除记录?')) {
            axios.delete(`/api/labelTemplates/${this.selectedRows[0].id}`).then(() => {
              alert('删除成功');
              this.fetchLabelTemplates();
            }).catch(error => {
              alert('删除失败：' + (error.response?.data?.message || error.message));
            });
          }
        },
        saveLabelTemplate() {
          this.$refs['labelTemplateForm'].validate((valid) => {
            if (valid) {
              const payload = { ...this.labelTemplateForm };
              const method = this.labelTemplateForm.id ? 'put' : 'post';
              const url = this.labelTemplateForm.id ? `/api/labelTemplates/${this.labelTemplateForm.id}` : '/api/labelTemplates';
              axios[method](url, payload).then(response => {
                if (response.status === 200 || response.status === 201) {
                  alert('保存成功');
                  this.showLabelTemplateForm = false;
                  this.fetchLabelTemplates();
                } else {
                  alert('保存失败：' + (response.data?.message || '未知错误'));
                }
              }).catch(error => {
                alert('保存失败：' + (error.response?.data?.message || error.message));
              });
            } else {
              alert('请填写完整信息');
            }
          });
        },
        handleSelectionChange(val) {
          this.selectedRows = val;
        }
      },
      mounted() {
        console.log('Mounted, fetching data...');
        this.fetchCategories();
        this.fetchSuppliers();
        this.fetchCustomers();
        this.fetchCounters();
        this.fetchStaff();
        this.fetchUsers();
        this.fetchSalesTemplates();
        this.fetchLabelTemplates();
      },
      watch: {
        categories: {
          handler(newCategories) {
            console.log('Categories changed, updating derived data:', JSON.stringify(newCategories, null, 2));
            this.updateAllSubCategories();
            this.updateSubCategoriesForSales();
            this.buildTree(this.categories);
            this.categoriesLoaded = true;
            this.$forceUpdate();
          },
          deep: true
        }
      }
    });
  </script>
</body>
</html>