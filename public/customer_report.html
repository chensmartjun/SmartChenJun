<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>客户报表</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/theme-chalk/index.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { width: 100%; height: 100%; font-family: Arial, sans-serif; }
    .content { padding: 20px; background: #f0f0f0; }
    .filter-bar { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; align-items: center; gap: 10px; }
    .table-section { background: #fff; padding: 20px; border-radius: 4px; }
    .el-button { padding: 0px 12px; font-size: 12px; height: 28px; }
  </style>
</head>
<body>
  <div id="app" class="content">
    <div class="filter-bar">
      <el-date-picker
        v-model="dateRange"
        type="daterange"
        range-separator="至"
        start-placeholder="开始日期"
        end-placeholder="结束日期"
        @change="fetchReport"
      ></el-date-picker>
      <el-button type="primary" size="small" @click="fetchReport">查询</el-button>
      <el-button type="success" size="small" @click="exportReport">导出 Excel</el-button>
    </div>
    <div class="table-section">
      <el-table :data="reportData" border style="width: 100%;">
        <el-table-column prop="customer_name" label="客户名称" width="150"></el-table-column>
        <el-table-column prop="order_count" label="订单数" width="100"></el-table-column>
        <el-table-column prop="total_weight" label="总金重 (g)" width="120"></el-table-column>
        <el-table-column prop="total_pure_weight" label="总净金重 (g)" width="120"></el-table-column>
        <el-table-column prop="total_cost" label="总费用 (元)" width="120"></el-table-column>
      </el-table>
    </div>
  </div>

  <script>
    if (typeof Vue === 'undefined') {
      console.error('Vue is not defined.');
    } else {
      new Vue({
        el: '#app',
        data() {
          return {
            dateRange: [],
            reportData: [],
          };
        },
        methods: {
          fetchReport() {
            const [start_date, end_date] = this.dateRange || [];
            const params = {};
            if (start_date && end_date) {
              params.start_date = this.formatDate(start_date, 'yyyy-MM-dd');
              params.end_date = this.formatDate(end_date, 'yyyy-MM-dd');
            }
            axios.get('/api/customerReport', { params })
              .then(response => {
                this.reportData = response.data.data || [];
                console.log('Fetched customer report:', this.reportData);
              })
              .catch(error => {
                console.error('Fetch customer report error:', error);
                this.reportData = [];
              });
          },
          exportReport() {
            const data = this.reportData.map(item => ({
              '客户名称': item.customer_name,
              '订单数': item.order_count,
              '总金重 (g)': item.total_weight,
              '总净金重 (g)': item.total_pure_weight,
              '总费用 (元)': item.total_cost,
            }));
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '客户报表');
            const buffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `customer_report_${this.formatDate(new Date(), 'yyyyMMdd')}.xlsx`);
            document.body.appendChild(link);
            link.click();
          },
          formatDate(date, formatStr) {
            const pad = (num) => String(num).padStart(2, '0');
            const year = date.getFullYear();
            const month = pad(date.getMonth() + 1);
            const day = pad(date.getDate());
            if (formatStr === 'yyyyMMdd') return `${year}${month}${day}`;
            return `${year}-${month}-${day}`;
          },
        },
        mounted() {
          this.fetchReport();
        },
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</body>
</html>