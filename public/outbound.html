<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>出库管理</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/theme-chalk/index.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { width: 100%; height: 100%; font-family: Arial, sans-serif; }
    .content { padding: 10px; overflow-y: auto; background: #f0f0f0; }
    .operation-bar {
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .pagination-buttons img {
      width: 30px;
      height: 30px;
      margin: 0 5px;
      cursor: pointer;
    }
    .pagination-buttons img.gray { opacity: 0.5; cursor: not-allowed; }
    .utility-buttons { display: flex; gap: 2px; }
    .utility-buttons .el-button, .action-buttons .el-button { height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
    .utility-buttons .el-button { color: #fff; border-color: #dcdcdc; }
    .utility-buttons .filter-btn { background-color: #9B59B6; }
    .utility-buttons .import-btn { background-color: #1ABC9C; }
    .utility-buttons .export-btn { background-color: #F1C40F; }
    .action-buttons { display: flex; flex-direction: row-reverse; gap: 2px; }
    .action-buttons .el-button { color: #fff; border-color: transparent; }
    .action-buttons .add-btn { background-color: #409EFF; }
    .action-buttons .edit-btn { background-color: #E6A23C; }
    .action-buttons .delete-btn { background-color: #F56C6C; }
    .action-buttons .save-btn { background-color: #67C23A; }
    .action-buttons .withdraw-btn { background-color: #E91E63; }
    .action-buttons .print-btn { background-color: #7F8C8D; }
    .utility-buttons .el-button:hover, .action-buttons .el-button:hover { opacity: 0.9; }
    .selection-bar { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; align-items: center; gap: 10px; }
    .el-button { padding: 0px 12px; font-size: 12px; height: 28px; display: flex; align-items: center; justify-content: center; min-width: 80px; }
    .form-section { background: #fff; padding: 20px; border-radius: 4px; margin-bottom: 10px; }
    .table-section { background: #fff; padding: 20px; border-radius: 4px; }
    .summary-section { background: #fff; padding: 10px; border-radius: 4px; margin-top: 10px; }
    .owed-section { background: #fff; padding: 10px; border-radius: 4px; margin-top: 10px; }
    .barcode-input { width: 150px; }
    .el-input.number-input { width: 100px; }
    .el-input.number-input .el-input__inner { -webkit-appearance: none; -moz-appearance: textfield; }
    .el-input.number-input .el-input__inner::-webkit-inner-spin-button,
    .el-input.number-input .el-input__inner::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    @media print {
      .operation-bar, .selection-bar, .form-section { display: none; }
      .table-section { display: block !important; padding: 0; }
      .el-table th, .el-table td { font-size: 10pt; padding: 2px; }
      .summary-section, .owed-section { font-size: 10pt; padding: 5px; }
    }
  </style>
</head>
<body>
  <div id="app" class="content">
    <div class="operation-bar">
      <div style="display: flex; align-items: center;">
        <div class="pagination-buttons">
          <img src="material/Page 1.png" alt="第一页" :class="{ gray: currentPage === 1 }" @click="goFirstPage">
          <img src="material/Previous Page.png" alt="上一页" :class="{ gray: currentPage === 1 }" @click="goPrevPage">
          <img src="material/Next Page.png" alt="下一页" :class="{ gray: currentPage === Math.ceil(total / pageSize) }" @click="goNextPage">
          <img src="material/Last Page.png" alt="最后一页" :class="{ gray: currentPage === Math.ceil(total / pageSize) }" @click="goLastPage">
        </div>
        <div class="utility-buttons">
          <el-button type="default" size="small" icon="el-icon-search" class="filter-btn" @click="fetchOutboundOrders">筛选</el-button>
          <el-button type="default" size="small" icon="el-icon-upload" class="import-btn" @click="importData">导入</el-button>
          <el-button type="default" size="small" icon="el-icon-download" class="export-btn" @click="exportData">导出</el-button>
        </div>
      </div>
      <div class="action-buttons">
        <el-button type="default" size="small" icon="el-icon-printer" class="print-btn" @click="showPrintPreview" :disabled="selectedRows.length === 0 && !currentOutboundOrder">打印</el-button>
        <el-button type="default" size="small" class="withdraw-btn" @click="withdraw">撤回</el-button>
        <el-button type="default" size="small" class="save-btn" @click="saveOutboundOrder" :disabled="!currentOutboundOrder">保存</el-button>
        <el-button type="default" size="small" class="delete-btn" @click="deleteOutboundOrder" :disabled="selectedRows.length === 0">删除</el-button>
        <el-button type="default" size="small" class="edit-btn" @click="editOutboundOrder" :disabled="selectedRows.length !== 1">修改</el-button>
        <el-button type="default" size="small" class="add-btn" @click="addOutboundOrder">新建</el-button>
      </div>
    </div>
    <div class="selection-bar" v-if="currentOutboundOrder">
      <el-input v-model="currentOutboundOrder.order_number" placeholder="出库单号" disabled style="width: 200px;"></el-input>
      <el-select v-model="currentOutboundOrder.customer_id" placeholder="请选择客户" style="width: 200px;" @change="loadCustomerData">
        <el-option v-for="customer in customers" :key="customer.id" :label="customer.short_name" :value="customer.id"></el-option>
      </el-select>
      <el-select v-model="currentOutboundOrder.counter_id" placeholder="请选择柜台" style="width: 200px;">
        <el-option v-for="counter in counters" :key="counter.id" :label="counter.name" :value="counter.id"></el-option>
      </el-select>
      <el-input v-model="currentOutboundOrder.date" placeholder="时间" disabled style="width: 150px;"></el-input>
      <el-radio-group v-model="currentOutboundOrder.settle_type">
        <el-radio label="price">结价</el-radio>
        <el-radio label="material">结料</el-radio>
      </el-radio-group>
    </div>
    <div class="form-section" v-if="currentOutboundOrder">
      <el-table :data="currentOutboundOrder.details" border style="width: 100%;">
        <el-table-column type="selection" width="55"></el-table-column>
        <el-table-column label="序号" type="index" width="60"></el-table-column>
        <el-table-column label="条形码" prop="barcode" width="150">
          <template slot-scope="scope">
            <el-input v-model="scope.row.barcode" class="barcode-input" @input="scanBarcode(scope.$index, scope.row)" placeholder="扫码输入" ref="barcodeInput"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="产品编码" prop="product_code" width="120">
          <template slot-scope="scope">
            <el-input v-model="scope.row.product_code" disabled></el-input>
          </template>
        </el-table-column>
        <el-table-column label="产品名称" prop="product_name" width="150">
          <template slot-scope="scope">
            <el-input v-model="scope.row.product_name" disabled></el-input>
          </template>
        </el-table-column>
        <el-table-column label="金重" prop="weight" width="100">
          <template slot-scope="scope">
            <el-input v-model.number="scope.row.weight" type="number" disabled class="number-input"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="净金重" prop="pure_weight" width="100">
          <template slot-scope="scope">
            <el-input v-model.number="scope.row.pure_weight" type="number" disabled class="number-input"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="工费" prop="labor_cost" width="100">
          <template slot-scope="scope">
            <el-input v-model.number="scope.row.labor_cost" type="number" @change="calculateTotalCost(scope.row)" class="number-input"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="件数" prop="quantity" width="100">
          <template slot-scope="scope">
            <el-input v-model.number="scope.row.quantity" type="number" @change="calculateTotalCost(scope.row)" min="1" class="number-input"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="附加费" prop="extra_fee" width="100">
          <template slot-scope="scope">
            <el-input v-model.number="scope.row.extra_fee" type="number" @change="calculateTotalCost(scope.row)" class="number-input"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="镶嵌/位" prop="inlay_count" width="100">
          <template slot-scope="scope">
            <el-input v-model.number="scope.row.inlay_count" type="number" @change="calculateTotalCost(scope.row)" class="number-input"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="镶嵌工费" prop="inlay_labor_cost" width="100">
          <template slot-scope="scope">
            <el-input v-model.number="scope.row.inlay_labor_cost" type="number" @change="calculateTotalCost(scope.row)" class="number-input"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="石重(ct)" prop="stone_weight" width="100">
          <template slot-scope="scope">
            <el-input v-model.number="scope.row.stone_weight" type="number" @change="calculateTotalCost(scope.row)" class="number-input"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="石价" prop="stone_price" width="100">
          <template slot-scope="scope">
            <el-input v-model.number="scope.row.stone_price" type="number" @change="calculateTotalCost(scope.row)" class="number-input"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="金价" prop="gold_price" width="100">
          <template slot-scope="scope">
            <el-input v-model.number="scope.row.gold_price" type="number" @change="calculateTotalCost(scope.row)" class="number-input"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="总工费" prop="total_cost" width="100">
          <template slot-scope="scope">
            <el-input v-model.number="scope.row.total_cost" disabled class="number-input"></el-input>
          </template>
        </el-table-column>
      </el-table>
      <el-button type="default" size="small" class="add-btn" @click="addDetail" style="margin-top: 10px;">添加产品</el-button>
    </div>
    <div class="summary-section" v-if="currentOutboundOrder">
      <el-row>
        <el-col :span="6">总金重: {{ Number(currentOutboundOrder.total_weight || 0).toFixed(2) }} g</el-col>
        <el-col :span="6">总净金重: {{ Number(currentOutboundOrder.total_pure_weight || 0).toFixed(2) }} g</el-col>
        <el-col :span="6">总费用: {{ Number(currentOutboundOrder.total_cost || 0).toFixed(2) }} 元</el-col>
      </el-row>
    </div>
    <div class="owed-section" v-if="currentOutboundOrder && showOwed">
      <h3>上期存欠明细</h3>
      <el-row :gutter="20">
        <el-col :span="6">项目名: {{ owedDetails[0].project }}</el-col>
        <el-col :span="6">存料/欠料: {{ owedDetails[0].material_amount }} g</el-col>
        <el-col :span="6">存工费/欠工费: {{ owedDetails[1].labor_amount }} 元</el-col>
      </el-row>
      <el-row :gutter="20" style="margin-top: 10px;">
        <el-col :span="12">总计存欠板料 (g): {{ totalOwedMaterial }}</el-col>
        <el-col :span="12">总计存欠工费 (元): {{ totalOwedLabor }}</el-col>
      </el-row>
    </div>
    <div class="table-section">
      <el-table :data="outboundOrders" border style="width: 100%;" @selection-change="handleSelectionChange">
        <el-table-column type="selection" width="55"></el-table-column>
        <el-table-column prop="order_number" label="出库单号"></el-table-column>
        <el-table-column prop="date" label="日期"></el-table-column>
        <el-table-column prop="customer.short_name" label="客户"></el-table-column>
        <el-table-column prop="counter.name" label="柜台"></el-table-column>
        <el-table-column prop="total_weight" label="总金重 (g)" width="120">
          <template slot-scope="scope">{{ Number(scope.row.total_weight + (scope.row.total_pure_weight || 0)).toFixed(2) }}</template>
        </el-table-column>
        <el-table-column prop="total_cost" label="总费用"></el-table-column>
      </el-table>
    </div>
    <el-dialog title="打印预览" :visible.sync="printPreviewVisible" width="60%">
      <el-select v-model="selectedTemplate" placeholder="选择模板" style="margin-bottom: 20px;" @change="updatePreviewColumns">
        <el-option label="模板 1 (金价+珐琅)" value="template1"></el-option>
        <el-option label="模板 2 (镶嵌+石头)" value="template2"></el-option>
        <el-option label="模板 3 (仅本单)" value="template3"></el-option>
      </el-select>
      <el-table :data="previewData" border style="width: 100%;">
        <el-table-column v-for="col in previewColumns" :key="col.prop" :label="col.label" :prop="col.prop" :width="col.width" :formatter="col.formatter" />
      </el-table>
      <div slot="footer">
        <el-button @click="printPreviewVisible = false">取消</el-button>
        <el-button type="primary" @click="confirmPrint">确认打印</el-button>
      </div>
    </el-dialog>
  </div>

  <script>
    if (typeof Vue === 'undefined') {
      console.error('Vue is not defined. Please check if the Vue script loaded correctly.');
    } else {
      new Vue({
        el: '#app',
        data() {
          return {
            customers: [],
            counters: [],
            outboundOrders: [],
            currentOutboundOrder: null,
            selectedRows: [],
            filter: { customer_id: '', counter_id: '', date: '' },
            currentPage: 1,
            pageSize: 10,
            total: 0,
            showOwed: true,
            owedDetails: [
              { project: '足金板料', material_amount: 0, labor_amount: 0 },
              { project: '工费', material_amount: 0, labor_amount: 0 },
            ],
            printPreviewVisible: false,
            selectedTemplate: 'template2',
            previewData: [],
            previewColumns: [],
            barcodeLength: 13,
          };
        },
        computed: {
          totalOwedMaterial() {
            const material = this.owedDetails.find(d => d.project === '足金板料');
            const current = this.currentOutboundOrder?.settle_type === 'material' ? this.currentOutboundOrder.total_pure_weight : 0;
            return Number(parseFloat(material.material_amount) + current).toFixed(2);
          },
          totalOwedLabor() {
            const labor = this.owedDetails.find(d => d.project === '工费');
            const current = this.currentOutboundOrder?.total_cost || 0;
            return Number(parseFloat(labor.labor_amount) + current).toFixed(2);
          },
        },
        methods: {
          fetchCustomers() {
            axios.get('/api/customers', { params: { page: 1, size: 999 } })
              .then(response => this.customers = response.data.data || [])
              .catch(error => console.error('Fetch customers error:', error));
          },
          fetchCounters() {
            axios.get('/api/counters', { params: { page: 1, size: 999 } })
              .then(response => this.counters = response.data.data || [])
              .catch(error => console.error('Fetch counters error:', error));
          },
          fetchOutboundOrders() {
            const params = { page: this.currentPage, size: this.pageSize, ...this.filter };
            if (params.date) params.date = this.formatDate(new Date(params.date), 'yyyy-MM-dd');
            axios.get('/api/outboundOrders', { params })
              .then(response => {
                this.outboundOrders = response.data.data || [];
                this.total = response.data.total || 0;
                console.log('Fetched outbound orders:', this.outboundOrders.map(o => o.id));
                this.selectedRows = [];
              })
              .catch(error => {
                console.error('Fetch outboundOrders error:', error);
                this.outboundOrders = [];
                this.total = 0;
                this.selectedRows = [];
              });
          },
          goFirstPage() {
            if (this.currentPage !== 1) {
              this.currentPage = 1;
              this.fetchOutboundOrders();
            }
          },
          goPrevPage() {
            if (this.currentPage > 1) {
              this.currentPage--;
              this.fetchOutboundOrders();
            }
          },
          goNextPage() {
            if (this.currentPage < Math.ceil(this.total / this.pageSize)) {
              this.currentPage++;
              this.fetchOutboundOrders();
            }
          },
          goLastPage() {
            if (this.currentPage !== Math.ceil(this.total / this.pageSize)) {
              this.currentPage = Math.ceil(this.total / this.pageSize);
              this.fetchOutboundOrders();
            }
          },
          addOutboundOrder() {
            const orderNumber = `OUT${this.formatDate(new Date(), 'yyyyMMdd')}${String(this.outboundOrders.length + 1).padStart(4, '0')}`;
            this.currentOutboundOrder = {
              order_number: orderNumber,
              date: this.formatDate(new Date(), 'yyyy-MM-dd HH:mm:ss'),
              customer_id: '',
              counter_id: '',
              settle_type: 'price',
              details: [],
              total_weight: 0,
              total_pure_weight: 0,
              total_cost: 0,
            };
            this.addDetail();
          },
          editOutboundOrder() {
            if (this.selectedRows.length === 1) {
              const row = this.selectedRows[0];
              axios.get(`/api/outboundOrders/${row.id}`)
                .then(response => {
                  if (response.data) {
                    this.currentOutboundOrder = { ...response.data };
                    this.currentOutboundOrder.details = this.currentOutboundOrder.OutboundOrderDetails.map(detail => ({
                      ...detail,
                      id: detail.id
                    })) || [];
                    this.currentOutboundOrder.settle_type = this.currentOutboundOrder.settle_price ? 'price' : 'material';
                    this.calculateTotals();
                    this.loadCustomerData();
                    console.log('Loaded order for editing:', this.currentOutboundOrder.id);
                  } else {
                    console.warn(`记录 ${row.id} 不存在，取消编辑`);
                    this.currentOutboundOrder = null;
                    this.fetchOutboundOrders();
                  }
                })
                .catch(error => {
                  if (error.response && error.response.status === 404) {
                    console.warn(`记录 ${row.id} 已不存在，可能已被删除`);
                    this.currentOutboundOrder = null;
                    this.fetchOutboundOrders();
                  } else {
                    console.error('Edit error:', error);
                  }
                });
            }
          },
          deleteOutboundOrder() {
            if (this.selectedRows.length > 0) {
              if (confirm('确定删除选中的记录？')) {
                const promises = this.selectedRows.map(row =>
                  axios.delete(`/api/outboundOrders/${row.id}`)
                    .catch(error => {
                      if (error.response && error.response.status === 404) {
                        console.warn(`记录 ${row.id} 已不存在，可能已被删除`);
                        return null;
                      }
                      throw error;
                    })
                );
                Promise.all(promises)
                  .then(results => {
                    alert('删除成功');
                    this.fetchOutboundOrders();
                    this.selectedRows = [];
                  })
                  .catch(error => {
                    alert('删除失败：' + (error.response?.data?.error || error.message));
                    this.fetchOutboundOrders();
                    this.selectedRows = [];
                  });
              }
            } else {
              alert('请至少选择一条记录进行删除');
            }
          },
          async saveOutboundOrder() {
            if (!this.currentOutboundOrder.customer_id || !this.currentOutboundOrder.counter_id || !this.currentOutboundOrder.settle_type) {
              alert('客户、柜台和结算类型为必填项');
              return;
            }
            const validDetails = this.currentOutboundOrder.details.filter(detail => detail.barcode && detail.barcode.trim() !== '');
            if (validDetails.length === 0) {
              alert('请至少填写一条有效的出库记录');
              return;
            }
            try {
              if (this.currentOutboundOrder.id) {
                await axios.put(`/api/outboundOrders/${this.currentOutboundOrder.id}`, {
                  ...this.currentOutboundOrder,
                  details: validDetails,
                  settle_price: this.currentOutboundOrder.settle_type === 'price',
                  settle_material: this.currentOutboundOrder.settle_type === 'material',
                });
              } else {
                const response = await axios.post('/api/outboundOrders', {
                  ...this.currentOutboundOrder,
                  details: validDetails,
                  settle_price: this.currentOutboundOrder.settle_type === 'price',
                  settle_material: this.currentOutboundOrder.settle_type === 'material',
                });
                this.currentOutboundOrder.id = response.data.order.id;
              }
              alert('保存成功');
              this.currentOutboundOrder = null;
              this.fetchOutboundOrders();
            } catch (error) {
              alert('保存失败：' + (error.response?.data?.error || error.message));
            }
          },
          withdraw() {
            this.currentOutboundOrder = null;
            alert('已回撤');
          },
          addDetail() {
            this.currentOutboundOrder.details.push({
              barcode: '',
              product_code: '',
              product_name: '',
              weight: 0,
              pure_weight: 0,
              labor_cost: 0,
              quantity: 1,
              extra_fee: 0,
              inlay_count: 0,
              inlay_labor_cost: 0,
              stone_weight: 0,
              stone_price: 0,
              gold_price: 0,
              total_cost: 0,
            });
            this.$nextTick(() => {
              const lastIndex = this.currentOutboundOrder.details.length - 1;
              const barcodeInput = this.$refs.barcodeInput && this.$refs.barcodeInput[lastIndex];
              if (barcodeInput && barcodeInput.$el) {
                barcodeInput.$el.querySelector('input').focus();
              } else {
                console.warn('Barcode input not found at index:', lastIndex);
              }
            });
          },
          removeDetail(index) {
            this.currentOutboundOrder.details.splice(index, 1);
            this.calculateTotals();
          },
          scanBarcode(index, row) {
            if (row.barcode && row.barcode.length === this.barcodeLength) {
              axios.get(`/api/inventory?barcode=${row.barcode}`)
                .then(response => {
                  const item = response.data.data[0];
                  if (!item) {
                    console.error('Inventory item not found for barcode:', row.barcode);
                    this.jumpToNextBarcode(index);
                    return;
                  }
                  axios.get(`/api/inboundOrders/details?barcode=${row.barcode}`)
                    .then(detailResponse => {
                      const inboundDetail = detailResponse.data.data[0] || {};
                      const customer = this.customers.find(c => c.id === this.currentOutboundOrder.customer_id);
                      const templateId = customer?.sales_template_id;

                      axios.get(`/api/categories/${item.product_code}`)
                        .then(categoryResponse => {
                          const category = categoryResponse.data.data;
                          const productCode = category?.parent_id ? category.name : item.product_code;

                          const baseData = {
                            product_code: productCode,
                            product_name: item.product_name,
                            weight: Number(inboundDetail.weight || item.weight || 0).toFixed(2),
                            pure_weight: Number(inboundDetail.pure_weight || item.pure_weight || 0).toFixed(2),
                            inlay_count: Number(inboundDetail.inlay_count || 0),
                            stone_weight: Number(inboundDetail.stone_weight || 0).toFixed(2),
                            labor_cost: Number(inboundDetail.labor_cost || 0).toFixed(2),
                            extra_fee: Number(inboundDetail.extra_fee || 0).toFixed(2),
                            inlay_labor_cost: Number(inboundDetail.inlay_labor_cost || 0).toFixed(2),
                            stone_price: Number(inboundDetail.stone_price || 0).toFixed(2),
                            gold_price: 0,
                            quantity: 1,
                          };

                          if (templateId) {
                            axios.get(`/api/salesTemplates/${templateId}`)
                              .then(templateResponse => {
                                const template = templateResponse.data.data;
                                console.log('Template Response:', template);
                                const pricing = template ? template.details.find(d => d.category_id === parseInt(item.product_code)) : null;
                                Object.assign(row, {
                                  ...baseData,
                                  labor_cost: Number(pricing?.labor_cost || baseData.labor_cost).toFixed(2),
                                  extra_fee: Number(pricing?.extra_fee || baseData.extra_fee).toFixed(2),
                                  inlay_labor_cost: Number(pricing?.inlay_labor_cost || baseData.inlay_labor_cost).toFixed(2),
                                  stone_price: Number(pricing?.stone_price || baseData.stone_price).toFixed(2),
                                });
                                this.calculateTotalCost(row);
                                this.jumpToNextBarcode(index);
                              })
                              .catch(error => {
                                console.error('Fetch sales template error:', error);
                                Object.assign(row, baseData);
                                this.calculateTotalCost(row);
                                this.jumpToNextBarcode(index);
                              });
                          } else {
                            Object.assign(row, baseData);
                            this.calculateTotalCost(row);
                            this.jumpToNextBarcode(index);
                          }
                        })
                        .catch(error => {
                          console.error('Fetch category error:', error);
                          Object.assign(row, {
                            ...baseData,
                            product_code: item.product_code,
                          });
                          this.calculateTotalCost(row);
                          this.jumpToNextBarcode(index);
                        });
                    })
                    .catch(error => {
                      console.error('Fetch inbound details error:', error);
                      this.jumpToNextBarcode(index);
                    });
                })
                .catch(error => {
                  console.error('Scan barcode error:', error);
                  this.jumpToNextBarcode(index);
                });
            }
          },
          jumpToNextBarcode(index) {
            const nextIndex = index + 1;
            if (nextIndex >= this.currentOutboundOrder.details.length) {
              this.addDetail();
            } else {
              this.$nextTick(() => {
                const barcodeInput = this.$refs.barcodeInput && this.$refs.barcodeInput[nextIndex];
                if (barcodeInput && barcodeInput.$el) {
                  barcodeInput.$el.querySelector('input').focus();
                } else {
                  console.warn('Barcode input not found at index:', nextIndex);
                }
              });
            }
          },
          calculateTotalCost(row) {
            const effectiveWeight = row.pure_weight || row.weight;
            const inlayFee = (row.inlay_count * row.inlay_labor_cost) + (row.stone_weight * row.stone_price);
            row.total_cost = Number((
              effectiveWeight * row.labor_cost +
              row.quantity * row.extra_fee +
              inlayFee
            ).toFixed(2));
            this.calculateTotals();
          },
          calculateTotals() {
            const details = this.currentOutboundOrder.details;
            this.currentOutboundOrder.total_weight = Number(details.reduce((sum, item) => sum + (item.weight * item.quantity), 0).toFixed(2));
            this.currentOutboundOrder.total_pure_weight = Number(details.reduce((sum, item) => sum + ((item.pure_weight || item.weight) * item.quantity), 0).toFixed(2));
            this.currentOutboundOrder.total_cost = Number(details.reduce((sum, item) => sum + item.total_cost, 0).toFixed(2));
          },
          showPrintPreview() {
            if (!this.currentOutboundOrder && this.selectedRows.length === 0) {
              this.$message.error('请选择要打印的记录');
              return;
            }
            const order = this.currentOutboundOrder || this.selectedRows[0];
            this.previewData = order.details.map((detail, index) => ({
              index: index + 1,
              product_name: detail.product_name,
              quantity: detail.quantity,
              weight: detail.weight,
              pure_weight: detail.pure_weight,
              labor_cost: detail.labor_cost,
              extra_fee: detail.extra_fee,
              inlay_count: detail.inlay_count,
              inlay_labor_cost: detail.inlay_labor_cost,
              stone_weight: detail.stone_weight,
              stone_price: detail.stone_price,
              gold_price: detail.gold_price,
              total_cost: detail.total_cost,
            }));
            this.updatePreviewColumns();
            this.printPreviewVisible = true;
          },
          updatePreviewColumns() {
            if (this.selectedTemplate === 'template1') {
              this.previewColumns = [
                { label: '序号', prop: 'index', width: '60' },
                { label: '产品名称', prop: 'product_name', width: '150' },
                { label: '数量', prop: 'quantity', width: '80' },
                { label: '毛重', prop: 'weight', width: '80' },
                { label: '净金重', prop: 'pure_weight', width: '80' },
                { label: '工费', prop: 'labor_cost', width: '80' },
                { label: '金价', prop: 'gold_price', width: '80' },
                { label: '珐琅附加费', prop: 'inlay_fee', width: '80', formatter: row => (row.inlay_count * row.inlay_labor_cost + row.stone_weight * row.stone_price).toFixed(2) },
                { label: '附加费', prop: 'extra_fee', width: '80' },
                { label: '合计', prop: 'total_cost', width: '100' },
              ];
            } else if (this.selectedTemplate === 'template2') {
              this.previewColumns = [
                { label: '序号', prop: 'index', width: '60' },
                { label: '产品名称', prop: 'product_name', width: '150' },
                { label: '数量', prop: 'quantity', width: '80' },
                { label: '毛重', prop: 'weight', width: '80' },
                { label: '净金重', prop: 'pure_weight', width: '80' },
                { label: '工费', prop: 'labor_cost', width: '80' },
                { label: '附加工费', prop: 'extra_fee', width: '80' },
                { label: '镶嵌位', prop: 'inlay_count', width: '80' },
                { label: '镶嵌工费', prop: 'inlay_labor_cost', width: '80' },
                { label: '石头/CT', prop: 'stone_weight', width: '80' },
                { label: '石头单价', prop: 'stone_price', width: '80' },
                { label: '合计', prop: 'total_cost', width: '100' },
              ];
            } else { // template3
              this.previewColumns = [
                { label: '序号', prop: 'index', width: '60' },
                { label: '产品名称', prop: 'product_name', width: '150' },
                { label: '数量', prop: 'quantity', width: '80' },
                { label: '毛重', prop: 'weight', width: '80' },
                { label: '净金重', prop: 'pure_weight', width: '80' },
                { label: '工费', prop: 'labor_cost', width: '80' },
                { label: '附加工费', prop: 'extra_fee', width: '80' },
                { label: '镶嵌位', prop: 'inlay_count', width: '80' },
                { label: '镶嵌工费', prop: 'inlay_labor_cost', width: '80' },
                { label: '石头/CT', prop: 'stone_weight', width: '80' },
                { label: '石头单价', prop: 'stone_price', width: '80' },
                { label: '合计', prop: 'total_cost', width: '100' },
              ];
              this.showOwed = false;
            }
          },
          confirmPrint() {
            const order = this.currentOutboundOrder || this.selectedRows[0];
            axios.post('/api/printVoucher', {
              type: 'outbound',
              order_id: order.id,
              template: this.selectedTemplate
            }, { responseType: 'blob' })
              .then(response => {
                const url = window.URL.createObjectURL(new Blob([response.data]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `outbound_voucher_${order.order_number}.xlsx`);
                document.body.appendChild(link);
                link.click();
                this.printPreviewVisible = false;
              })
              .catch(error => this.$message.error('打印失败: ' + (error.response?.data?.error || error.message)));
          },
          importData() {
            alert('导入功能待实现');
          },
          exportData() {
            const data = this.outboundOrders.map(order => ({
              order_number: order.order_number,
              date: order.date,
              customer: order.customer?.short_name,
              counter: order.counter?.name,
              total_weight: Number(order.total_weight + (order.total_pure_weight || 0)).toFixed(2), // 包含金重+净金重
              total_cost: order.total_cost,
            }));
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'OutboundOrders');
            const buffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `outbound_orders_${this.formatDate(new Date(), 'yyyyMMdd')}.xlsx`);
            document.body.appendChild(link);
            link.click();
          },
          loadCustomerData() {
            if (this.currentOutboundOrder.customer_id) {
              axios.get(`/api/customerOwed?customer_id=${this.currentOutboundOrder.customer_id}`)
                .then(response => {
                  this.owedDetails = [
                    { project: '足金板料', material_amount: Number(response.data.material_amount || 0).toFixed(2), labor_amount: 0 },
                    { project: '工费', material_amount: 0, labor_amount: Number(response.data.labor_amount || 0).toFixed(2) },
                  ];
                  this.showOwed = true;
                })
                .catch(error => console.error('Load owed error:', error));
            }
          },
          formatDate(date, formatStr) {
            const pad = (num) => String(num).padStart(2, '0');
            const year = date.getFullYear();
            const month = pad(date.getMonth() + 1);
            const day = pad(date.getDate());
            const hours = pad(date.getHours());
            const minutes = pad(date.getMinutes());
            const seconds = pad(date.getSeconds());
            if (formatStr === 'yyyyMMdd') return `${year}${month}${day}`;
            if (formatStr === 'yyyy-MM-dd') return `${year}-${month}-${day}`;
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
          },
          handleSelectionChange(val) {
            this.selectedRows = val;
          },
        },
        mounted() {
          console.log('Mounted, fetching data...');
          this.fetchCustomers();
          this.fetchCounters();
          this.fetchOutboundOrders();
        },
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
</body>
</html>