<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>入库管理</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/theme-chalk/index.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { width: 100%; height: 100%; font-family: Arial, sans-serif; }
    .content { padding: 10px; overflow-y: auto; background: #f0f0f0; }
    .operation-bar {
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .pagination-buttons img {
      width: 30px;
      height: 30px;
      margin: 0 5px;
      cursor: pointer;
    }
    .pagination-buttons img.gray { opacity: 0.5; cursor: not-allowed; }
    .utility-buttons { display: flex; gap: 2px; }
    .utility-buttons .el-button, .action-buttons .el-button { height: 28    px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
    .utility-buttons .el-button { color: #fff; border-color: #dcdcdc; }
    .utility-buttons .filter-btn { background-color: #9B59B6; }
    .utility-buttons .import-btn { background-color: #1ABC9C; }
    .utility-buttons .export-btn { background-color: #F1C40F; }
    .action-buttons { display: flex; flex-direction: row-reverse; gap: 2px; }
    .action-buttons .el-button { color: #fff; border-color: transparent; }
    .action-buttons .add-btn { background-color: #409EFF; }
    .action-buttons .edit-btn { background-color: #E6A23C; }
    .action-buttons .delete-btn { background-color: #F56C6C; }
    .action-buttons .save-btn { background-color: #67C23A; }
    .action-buttons .withdraw-btn { background-color: #E91E63; }
    .action-buttons .print-btn { background-color: #7F8C8D; }
    .utility-buttons .el-button:hover, .action-buttons .el-button:hover { opacity: 0.9; }
    .selection-bar { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; align-items: center; gap: 10px; }
    .el-button { padding: 0px 12px; font-size: 12px; height: 28px; display: flex; align-items: center; justify-content: center; min-width: 80px; }
    .form-section { background: #fff; padding: 20px; border-radius: 4px; margin-bottom: 10px; }
    .table-section { background: #fff; padding: 20px; border-radius: 4px; }
    .summary-section { background: #fff; padding: 10px; border-radius: 4px; margin-top: 10px; }
    .el-input input[type="number"]::-webkit-inner-spin-button,
    .el-input input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .el-input input[type="number"] { -moz-appearance: textfield; }
    .batch-add-dialog .el-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .batch-add-dialog .el-form-item {
      flex: 1 1 45%;
      margin-bottom: 10px;
    }
    .batch-add-dialog .el-form-item.weights {
      flex: 1 1 100%;
    }
    .batch-add-dialog .el-table {
      margin-top: 10px;
    }
    .batch-add-dialog .el-button.add-weight-btn {
      margin-top: 5px;
    }
    .barcode-text, .order-number-text { cursor: pointer; color: #409EFF; }
    @media print {
      .operation-bar, .selection-bar, .form-section { display: none; }
      .table-section { display: block !important; padding: 0; }
      .el-table th, .el-table td { font-size: 10pt; padding: 2px; }
      .summary-section { font-size: 10pt; padding: 5px; }
    }
  </style>
</head>
<body>
  <div id="app" class="content">
    <div class="operation-bar">
      <div style="display: flex; align-items: center;">
        <div class="pagination-buttons">
          <img src="material/Page 1.png" alt="第一页" :class="{ gray: currentPage === 1 }" @click="goFirstPage">
          <img src="material/Previous Page.png" alt="上一页" :class="{ gray: currentPage === 1 }" @click="goPrevPage">
          <img src="material/Next Page.png" alt="下一页" :class="{ gray: currentPage === Math.ceil(total / pageSize) }" @click="goNextPage">
          <img src="material/Last Page.png" alt="最后一页" :class="{ gray: currentPage === Math.ceil(total / pageSize) }" @click="goLastPage">
        </div>
        <div class="utility-buttons">
          <el-button type="default" size="small" icon="el-icon-search" class="filter-btn" @click="fetchInboundOrders">筛选</el-button>
          <el-button type="default" size="small" icon="el-icon-upload" class="import-btn" @click="importData">导入</el-button>
          <el-button type="default" size="small" icon="el-icon-download" class="export-btn" @click="exportData">导出</el-button>
        </div>
      </div>
      <div class="action-buttons">
        <el-button type="default" size="small" icon="el-icon-printer" class="print-btn" @click="printVoucher">打印</el-button>
        <el-button type="default" size="small" class="withdraw-btn" @click="withdraw">撤回</el-button>
        <el-button type="default" size="small" class="save-btn" @click="saveInboundOrder" :disabled="!currentInboundOrder">保存</el-button>
        <el-button type="default" size="small" class="delete-btn" @click="deleteInboundOrder" :disabled="selectedRows.length === 0">删除</el-button>
        <el-button type="default" size="small" class="edit-btn" @click="editInboundOrder" :disabled="selectedRows.length !== 1">修改</el-button>
        <el-button type="default" size="small" class="add-btn" @click="addInboundOrder">新建</el-button>
      </div>
    </div>
    <div class="selection-bar" v-if="currentInboundOrder">
      <el-input v-model="currentInboundOrder.order_number" placeholder="入库单号" disabled style="width: 200px;"></el-input>
      <el-select v-model="currentInboundOrder.supplier_id" placeholder="请选择供应商" style="width: 200px;" @change="loadSupplierData">
        <el-option v-for="supplier in suppliers" :key="supplier.id" :label="supplier.short_name" :value="supplier.id"></el-option>
      </el-select>
      <el-select v-model="currentInboundOrder.counter_id" placeholder="请选择柜台" style="width: 200px;">
        <el-option v-for="counter in counters" :key="counter.id" :label="counter.name" :value="counter.id"></el-option>
      </el-select>
      <span style="width: 200px; display: inline-block;">{{ currentInboundOrder.date }}</span>
      <el-radio-group v-model="currentInboundOrder.settle_type" @change="updateTableColumns">
        <el-radio label="price">结价</el-radio>
        <el-radio label="material">结料</el-radio>
      </el-radio-group>
    </div>
    <div class="form-section" v-if="currentInboundOrder">
      <el-table :data="currentInboundOrder.details" border style="width: 100%;">
        <el-table-column type="selection" width="55"></el-table-column>
        <el-table-column label="序号" type="index" width="60"></el-table-column>
        <el-table-column label="条形码" prop="barcode" width="150">
          <template slot-scope="scope">
            <span class="barcode-text" @click="copyText(scope.row.barcode)">{{ scope.row.barcode }}</span>
          </template>
        </el-table-column>
        <el-table-column label="产品类目" prop="product_code" width="150">
          <template slot-scope="scope">
            <el-select v-model="scope.row.product_code" placeholder="请选择产品类目" filterable :filter-method="filterCategory" @change="updateSubCategories(scope.$index)">
              <el-option v-for="parent in filteredCategories" :key="parent.id" :label="parent.name" :value="parent.id"></el-option>
            </el-select>
          </template>
        </el-table-column>
        <el-table-column label="产品名称" prop="product_name" width="200">
          <template slot-scope="scope">
            <el-select v-model="scope.row.product_name" placeholder="请选择产品名称" filterable :filter-method="filterProductName(scope.$index)" @change="updateProductDetails(scope.row)">
              <el-option v-for="category in filteredSubCategories[scope.$index] || []" :key="category.id" :label="category.name + ' (' + (category.code || '无代码') + ')'" :value="category.code || category.name"></el-option>
            </el-select>
          </template>
        </el-table-column>
        <el-table-column label="重量类型" prop="weight_type" width="120">
          <template slot-scope="scope">
            <el-select v-model="scope.row.weight_type" @change="toggleWeightInput(scope.row)">
              <el-option label="金重" value="weight"></el-option>
              <el-option label="净金重" value="pure_weight"></el-option>
            </el-select>
          </template>
        </el-table-column>
        <el-table-column label="金重" prop="weight" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.weight" type="text" :disabled="scope.row.weight_type === 'pure_weight'" @input="restrictNumberInput(scope.row, 'weight', 2)" @change="calculateTotalCost(scope.row)"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="净金重" prop="pure_weight" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.pure_weight" type="text" :disabled="scope.row.weight_type === 'weight'" @input="restrictNumberInput(scope.row, 'pure_weight', 2)" @change="calculateTotalCost(scope.row)"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="工费" prop="labor_cost" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.labor_cost" type="text" @input="restrictNumberInput(scope.row, 'labor_cost', 2)" @change="calculateTotalCost(scope.row)"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="件数" prop="quantity" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.quantity" type="text" @input="restrictNumberInput(scope.row, 'quantity', 0)" @change="calculateTotalCost(scope.row)"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="附加费" prop="extra_fee" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.extra_fee" type="text" @input="restrictNumberInput(scope.row, 'extra_fee', 2)" @change="calculateTotalCost(scope.row)"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="镶嵌/位" prop="inlay_count" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.inlay_count" type="text" @input="restrictNumberInput(scope.row, 'inlay_count', 0)" @change="calculateTotalCost(scope.row)"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="镶嵌工费" prop="inlay_labor_cost" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.inlay_labor_cost" type="text" @input="restrictNumberInput(scope.row, 'inlay_labor_cost', 2)" @change="calculateTotalCost(scope.row)"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="石重(ct)" prop="stone_weight" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.stone_weight" type="text" @input="restrictNumberInput(scope.row, 'stone_weight', 2)" @change="calculateTotalCost(scope.row)"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="石价" prop="stone_price" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.stone_price" type="text" @input="restrictNumberInput(scope.row, 'stone_price', 2)" @change="calculateTotalCost(scope.row)"></el-input>
          </template>
        </el-table-column>
        <el-table-column v-if="currentInboundOrder.settle_type === 'price'" label="金价 (元/g)" prop="gold_price" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.gold_price" type="text" @input="restrictNumberInput(scope.row, 'gold_price', 2)" @change="calculateTotalCost(scope.row)"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="总工费" prop="total_cost" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.total_cost" disabled></el-input>
          </template>
        </el-table-column>
        <el-table-column v-if="currentInboundOrder.settle_type === 'price'" label="金价金额" prop="gold_amount" width="120">
          <template slot-scope="scope">
            <el-input v-model="scope.row.gold_amount" disabled></el-input>
          </template>
        </el-table-column>
        <el-table-column label="备注" prop="remark" width="100">
          <template slot-scope="scope">
            <el-input v-model="scope.row.remark"></el-input>
          </template>
        </el-table-column>
      </el-table>
      <el-button type="default" size="small" class="add-btn" @click="addDetail" style="margin-top: 10px;">添加产品</el-button>
      <el-button type="default" size="small" class="add-btn" @click="showBatchAddDialog = true" style="margin-top: 10px; margin-left: 10px;">批量添加</el-button>
      <el-dialog title="批量添加入库产品" :visible.sync="showBatchAddDialog" width="60%" class="batch-add-dialog">
        <el-form :model="batchForm" label-width="80px">
          <el-form-item label="产品类目">
            <el-select v-model="batchForm.product_code" placeholder="请选择产品类目" filterable :filter-method="filterCategory" @change="updateBatchSubCategories">
              <el-option v-for="parent in filteredCategories" :key="parent.id" :label="parent.name" :value="parent.id"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="产品名称">
            <el-select v-model="batchForm.product_name" placeholder="请选择产品名称" filterable>
              <el-option v-for="category in filteredBatchSubCategories" :key="category.id" :label="category.name + ' (' + (category.code || '无代码') + ')'" :value="category.code || category.name"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="工费">
            <el-input v-model="batchForm.labor_cost" type="text" @input="restrictNumberInput(batchForm, 'labor_cost', 2)"></el-input>
          </el-form-item>
          <el-form-item label="附加费">
            <el-input v-model="batchForm.extra_fee" type="text" @input="restrictNumberInput(batchForm, 'extra_fee', 2)"></el-input>
          </el-form-item>
          <el-form-item label="镶嵌/位">
            <el-input v-model="batchForm.inlay_count" type="text" @input="restrictNumberInput(batchForm, 'inlay_count', 0)"></el-input>
          </el-form-item>
          <el-form-item label="镶嵌工费">
            <el-input v-model="batchForm.inlay_labor_cost" type="text" @input="restrictNumberInput(batchForm, 'inlay_labor_cost', 2)"></el-input>
          </el-form-item>
          <el-form-item label="石重(ct)">
            <el-input v-model="batchForm.stone_weight" type="text" @input="restrictNumberInput(batchForm, 'stone_weight', 2)"></el-input>
          </el-form-item>
          <el-form-item label="石价">
            <el-input v-model="batchForm.stone_price" type="text" @input="restrictNumberInput(batchForm, 'stone_price', 2)"></el-input>
          </el-form-item>
          <el-form-item v-if="currentInboundOrder.settle_type === 'price'" label="金价">
            <el-input v-model="batchForm.gold_price" type="text" @input="restrictNumberInput(batchForm, 'gold_price', 2)"></el-input>
          </el-form-item>
          <el-form-item label="重量类型" class="weights">
            <el-select v-model="batchForm.weight_type" @change="toggleBatchWeightInput">
              <el-option label="金重" value="weight"></el-option>
              <el-option label="净金重" value="pure_weight"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="金重/净金重" class="weights">
            <el-table :data="batchWeights" border style="width: 100%;">
              <el-table-column label="金重" width="100">
                <template slot-scope="scope">
                  <el-input v-model="scope.row.weight" type="text" :disabled="batchForm.weight_type === 'pure_weight'" @input="restrictNumberInput(scope.row, 'weight', 2)"></el-input>
                </template>
              </el-table-column>
              <el-table-column label="净金重" width="100">
                <template slot-scope="scope">
                  <el-input v-model="scope.row.pure_weight" type="text" :disabled="batchForm.weight_type === 'weight'" @input="restrictNumberInput(scope.row, 'pure_weight', 2)"></el-input>
                </template>
              </el-table-column>
              <el-table-column label="操作" width="80">
                <template slot-scope="scope">
                  <el-button type="text" @click="removeBatchWeight(scope.$index)">删除</el-button>
                </template>
              </el-table-column>
            </el-table>
            <el-button type="default" size="small" class="add-weight-btn" @click="addBatchWeight" :disabled="batchWeights.length >= 50">添加金重</el-button>
            <span v-if="batchWeights.length >= 50" style="color: red; margin-left: 10px;">已达上限 (50 件)</span>
          </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
          <el-button @click="showBatchAddDialog = false">取消</el-button>
          <el-button type="primary" @click="submitBatchAdd">确认</el-button>
        </div>
      </el-dialog>
    </div>
    <div class="summary-section" v-if="currentInboundOrder">
      <el-row>
        <el-col :span="6">入库单号: <span class="order-number-text" @click="copyText(currentInboundOrder.order_number)">{{ currentInboundOrder.order_number || '未保存' }}</span></el-col>
        <el-col :span="6">日期: {{ currentInboundOrder.date }}</el-col>
        <el-col :span="6">供应商: {{ getSupplierName(currentInboundOrder.supplier_id) }}</el-col>
        <el-col :span="6">柜台: {{ getCounterName(currentInboundOrder.counter_id) }}</el-col>
        <el-col :span="6">总金重: {{ Number(currentInboundOrder.total_weight || 0).toFixed(2) }} g</el-col>
        <el-col :span="6">总净金重: {{ Number(currentInboundOrder.total_pure_weight || 0).toFixed(2) }} g</el-col>
        <el-col :span="6">总件数: {{ totalQuantity || 0 }}</el-col>
        <el-col :span="6">总费用: {{ Number(currentInboundOrder.total_cost || 0).toFixed(2) }} 元</el-col>
        <el-col v-if="currentInboundOrder.settle_type === 'price'" :span="6">总金价金额: {{ Number(currentInboundOrder.total_gold_amount || 0).toFixed(2) }} 元</el-col>
      </el-row>
    </div>
    <div class="table-section">
      <el-table :data="inboundOrders" border style="width: 100%;" @selection-change="handleSelectionChange">
        <el-table-column type="selection" width="55"></el-table-column>
        <el-table-column prop="order_number" label="入库单号"></el-table-column>
        <el-table-column prop="date" label="日期"></el-table-column>
        <el-table-column prop="supplier.short_name" label="供应商"></el-table-column>
        <el-table-column prop="counter.name" label="柜台"></el-table-column>
        <el-table-column prop="total_cost" label="总费用"></el-table-column>
      </el-table>
    </div>
  </div>

  <script>
    new Vue({
      el: '#app',
      data() {
        return {
          suppliers: [],
          counters: [],
          categories: [],
          uniqueParentCategories: [],
          filteredCategories: [],
          filteredSubCategories: [],
          filteredBatchSubCategories: [],
          inboundOrders: [],
          currentInboundOrder: {},
          selectedRows: [],
          filter: {
            supplier_id: '',
            counter_id: '',
            date: '',
          },
          currentPage: 1,
          pageSize: 10,
          total: 0,
          showBatchAddDialog: false,
          batchForm: {
            product_code: '',
            product_name: '',
            labor_cost: '',
            extra_fee: '',
            inlay_count: 0,
            inlay_labor_cost: '',
            stone_weight: '',
            stone_price: '',
            gold_price: '',
            weight_type: 'weight', // 默认金重
          },
          batchWeights: [{ weight: '', pure_weight: '' }],
          totalQuantity: 0,
          inboundRules: {
            supplier_id: [{ required: true, message: '请选择供应商', trigger: 'change' }],
            counter_id: [{ required: true, message: '请选择柜台', trigger: 'change' }],
          },
        };
      },
      methods: {
        fetchSuppliers() {
          axios.get('/api/suppliers', { params: { page: 1, size: 999 } })
            .then(response => this.suppliers = response.data.data || [])
            .catch(error => console.error('Fetch suppliers error:', error));
        },
        fetchCounters() {
          axios.get('/api/counters', { params: { page: 1, size: 999 } })
            .then(response => this.counters = response.data.data || [])
            .catch(error => console.error('Fetch counters error:', error));
        },
        fetchCategories() {
          axios.get('/api/categories')
            .then(response => {
              this.categories = response.data.data || [];
              console.log('Categories fetched:', this.categories);
              console.log('First category sample:', JSON.stringify(this.categories[0]));
              if (this.categories.length === 0) {
                this.categories = [
                  { id: 1, code: null, name: '戒指', parent_id: null, description: '' },
                  { id: 2, code: 'R001', name: '黄金戒指', parent_id: 1, description: '' },
                  { id: 3, code: 'R002', name: '白金戒指', parent_id: 1, description: '' },
                ];
                console.warn('No categories from API, using default data:', this.categories);
              }
              this.uniqueParentCategories = this.categories.filter(cat => cat.parent_id === null);
              console.log('Unique parent categories:', this.uniqueParentCategories);
              this.$set(this, 'filteredCategories', [...this.uniqueParentCategories]);
              console.log('Filtered categories:', this.filteredCategories);
              this.filteredSubCategories = [];
              this.filteredBatchSubCategories = [];
              this.$forceUpdate();
            })
            .catch(error => {
              console.error('Fetch categories error:', error);
              this.categories = [
                { id: 1, code: null, name: '戒指', parent_id: null, description: '' },
                { id: 2, code: 'R001', name: '黄金戒指', parent_id: 1, description: '' },
                { id: 3, code: 'R002', name: '白金戒指', parent_id: 1, description: '' },
              ];
              this.uniqueParentCategories = this.categories.filter(cat => cat.parent_id === null);
              this.$set(this, 'filteredCategories', [...this.uniqueParentCategories]);
              this.$forceUpdate();
            });
        },
        fetchInboundOrders() {
          const params = { page: this.currentPage, size: this.pageSize, ...this.filter };
          if (params.date) params.date = this.formatDate(new Date(params.date), 'yyyy-MM-dd');
          axios.get('/api/inboundOrders', { params })
            .then(response => {
              this.inboundOrders = response.data.data || [];
              this.total = response.data.total || 0;
            })
            .catch(error => console.error('Fetch inboundOrders error:', error));
        },
        goFirstPage() {
          if (this.currentPage !== 1) {
            this.currentPage = 1;
            this.fetchInboundOrders();
          }
        },
        goPrevPage() {
          if (this.currentPage > 1) {
            this.currentPage--;
            this.fetchInboundOrders();
          }
        },
        goNextPage() {
          if (this.currentPage < Math.ceil(this.total / this.pageSize)) {
            this.currentPage++;
            this.fetchInboundOrders();
          }
        },
        goLastPage() {
          if (this.currentPage !== Math.ceil(this.total / this.pageSize)) {
            this.currentPage = Math.ceil(this.total / this.pageSize);
            this.fetchInboundOrders();
          }
        },
        addInboundOrder() {
          this.currentInboundOrder = {
            order_number: '',
            date: this.formatDate(new Date(), 'yyyy-MM-dd HH:mm:ss'),
            supplier_id: '',
            counter_id: '',
            settle_type: 'price',
            details: [],
            total_weight: 0,
            total_pure_weight: 0,
            total_cost: 0,
            total_gold_amount: 0,
          };
          this.totalQuantity = 0;
        },
        editInboundOrder() {
          if (this.selectedRows.length === 1) {
            axios.get(`/api/inboundOrders/${this.selectedRows[0].id}`)
              .then(response => {
                const order = response.data;
                this.currentInboundOrder = {
                  id: order.id,
                  order_number: order.order_number,
                  date: this.formatDate(new Date(), 'yyyy-MM-dd HH:mm:ss'),
                  supplier_id: order.supplier_id,
                  counter_id: order.counter_id,
                  settle_type: order.settle_price ? 'price' : 'material',
                  details: order.InboundOrderDetails.map(detail => ({
                    barcode: detail.barcode,
                    product_code: detail.product_code,
                    product_name: detail.product_name,
                    weight_type: detail.weight_type || 'weight', // 默认金重
                    weight: detail.weight.toString(),
                    pure_weight: detail.pure_weight.toString(),
                    labor_cost: detail.labor_cost.toString(),
                    quantity: detail.quantity,
                    extra_fee: detail.extra_fee.toString(),
                    inlay_count: detail.inlay_count,
                    inlay_labor_cost: detail.inlay_labor_cost.toString(),
                    stone_weight: detail.stone_weight.toString(),
                    stone_price: detail.stone_price.toString(),
                    total_cost: detail.total_cost.toString(),
                    remark: detail.remark || '',
                    ...(order.settle_type === 'price' ? { gold_price: detail.gold_price?.toString() || '', gold_amount: detail.gold_amount?.toString() || '0' } : {})
                  })),
                  total_weight: parseFloat(order.total_weight) || 0,
                  total_pure_weight: parseFloat(order.total_pure_weight) || 0,
                  total_cost: parseFloat(order.total_cost) || 0,
                  total_gold_amount: parseFloat(order.total_gold_amount) || 0,
                };
                this.filteredSubCategories = this.currentInboundOrder.details.map(detail => {
                  const parentCategory = this.categories.find(cat => cat.name === detail.product_code && cat.parent_id === null);
                  return parentCategory ? this.categories.filter(cat => cat.parent_id === parentCategory.id) : [];
                });
                this.calculateTotals();
              })
              .catch(error => console.error('Edit error:', error));
          }
        },
        deleteInboundOrder() {
          if (this.selectedRows.length > 0) {
            if (confirm('确定删除选中的记录？')) {
              const promises = this.selectedRows.map(row => {
                console.log('Deleting order with ID:', row.id);
                return axios.delete(`/api/inboundOrders/${row.id}`);
              });
              Promise.all(promises)
                .then(() => {
                  alert('删除成功');
                  this.fetchInboundOrders();
                })
                .catch(error => {
                  console.error('Delete error:', error.response ? error.response.data : error.message);
                  alert('删除失败：' + (error.response ? error.response.data.message : error.message));
                });
            }
          }
        },
        async saveInboundOrder() {
          console.log('Saving inbound order:', JSON.stringify(this.currentInboundOrder));
          try {
            if (!this.currentInboundOrder.supplier_id) {
              this.$message.error('请选择供应商');
              return;
            }
            if (!this.currentInboundOrder.counter_id) {
              this.$message.error('请选择柜台');
              return;
            }
            this.currentInboundOrder.details.forEach(detail => {
              if (!detail.barcode) detail.barcode = this.generateEAN13();
              detail.weight = detail.weight_type === 'weight' ? parseFloat(detail.weight) || 0 : 0;
              detail.pure_weight = detail.weight_type === 'pure_weight' ? parseFloat(detail.pure_weight) || 0 : 0;
              detail.labor_cost = parseFloat(detail.labor_cost) || 0;
              detail.quantity = parseInt(detail.quantity) || 1;
              detail.extra_fee = parseFloat(detail.extra_fee) || 0;
              detail.inlay_count = parseInt(detail.inlay_count) || 0;
              detail.inlay_labor_cost = parseFloat(detail.inlay_labor_cost) || 0;
              detail.stone_weight = parseFloat(detail.stone_weight) || 0;
              detail.stone_price = parseFloat(detail.stone_price) || 0;
              detail.total_cost = parseFloat(detail.total_cost) || 0;
              if (this.currentInboundOrder.settle_type === 'price') {
                detail.gold_price = parseFloat(detail.gold_price) || 0;
                detail.gold_amount = parseFloat(detail.gold_amount) || 0;
              }
            });

            const orderData = { ...this.currentInboundOrder };
            let response;
            if (orderData.id) {
              response = await axios.put(`/api/inboundOrders/${orderData.id}`, orderData);
              await axios.post('/api/inventory/reset', { order_id: orderData.id });
            } else {
              response = await axios.post('/api/inboundOrders', orderData);
            }
            console.log('Save response:', response.data);

            await axios.post('/api/inventory/update', {
              details: this.currentInboundOrder.details,
              counter_id: this.currentInboundOrder.counter_id,
              type: 'inbound'
            });
            if (this.currentInboundOrder.settle_type === 'material') {
              await axios.post('/api/materialInventory/update', {
                material_type: '足金板料',
                weight: -this.currentInboundOrder.total_pure_weight
              });
            }
            alert('保存成功');
            this.currentInboundOrder = {};
            this.filteredSubCategories = [];
            this.fetchInboundOrders();
          } catch (error) {
            console.error('Save error:', error.response ? error.response.data : error.message);
            alert('保存失败：' + (error.response && error.response.data ? error.response.data.error || error.response.data.message : error.message));
          }
        },
        withdraw() {
          this.currentInboundOrder = {};
          this.filteredSubCategories = [];
          this.totalQuantity = 0;
          alert('已回撤');
        },
        addDetail() {
          if (!this.currentInboundOrder) {
            alert('请先新建入库单！');
            return;
          }
          if (!this.currentInboundOrder.details) this.currentInboundOrder.details = [];
          const barcode = this.generateEAN13();
          const newDetail = {
            barcode,
            product_code: '',
            product_name: '',
            weight_type: 'weight', // 默认金重
            weight: '',
            pure_weight: '',
            labor_cost: '',
            quantity: 1,
            extra_fee: '',
            inlay_count: 0,
            inlay_labor_cost: '',
            stone_weight: '',
            stone_price: '',
            total_cost: 0,
            remark: '',
          };
          if (this.currentInboundOrder.settle_type === 'price') {
            newDetail.gold_price = '';
            newDetail.gold_amount = 0;
          }
          this.currentInboundOrder.details.push(newDetail);
          this.filteredSubCategories.push([]);
          this.calculateTotals();
        },
        toggleWeightInput(row) {
          if (row.weight_type === 'weight') {
            row.pure_weight = '';
          } else {
            row.weight = '';
          }
          this.calculateTotalCost(row);
        },
        toggleBatchWeightInput() {
          this.batchWeights.forEach(weight => {
            if (this.batchForm.weight_type === 'weight') {
              weight.pure_weight = '';
            } else {
              weight.weight = '';
            }
          });
        },
        updateTableColumns() {
          this.currentInboundOrder.details = this.currentInboundOrder.details.map(detail => {
            if (this.currentInboundOrder.settle_type === 'price' && !detail.hasOwnProperty('gold_price')) {
              return { ...detail, gold_price: '', gold_amount: 0 };
            } else if (this.currentInboundOrder.settle_type === 'material') {
              const { gold_price, gold_amount, ...rest } = detail;
              return rest;
            }
            return detail;
          });
          this.calculateTotals();
        },
        updateSubCategories(index) {
          const parentId = this.currentInboundOrder.details[index].product_code;
          const subCategories = this.categories.filter(cat => cat.parent_id === parentId);
          this.$set(this.filteredSubCategories, index, subCategories);
          this.currentInboundOrder.details[index].product_name = '';
          console.log('Subcategories for index', index, ':', subCategories);
        },
        updateProductDetails(row) {
          const category = this.categories.find(cat => (cat.code || cat.name) === row.product_name);
          if (category) {
            row.product_name = `${category.name} (${category.code || '无代码'})`;
          }
          this.calculateTotalCost(row);
        },
        calculateTotalCost(row) {
  const effectiveWeight = row.weight_type === 'weight' ? parseFloat(row.weight) || 0 : parseFloat(row.pure_weight) || 0;
  const laborCost = parseFloat(row.labor_cost) || 0;
  const extraFee = parseFloat(row.extra_fee) || 0;
  const inlayLaborCost = parseFloat(row.inlay_labor_cost) || 0;
  const stonePrice = parseFloat(row.stone_price) || 0;
  const stoneWeight = parseFloat(row.stone_weight) || 0;
  const quantity = parseInt(row.quantity) || 1;
  const inlayCount = parseInt(row.inlay_count) || 0;

  row.total_cost = Number(
    (effectiveWeight * laborCost +
    quantity * extraFee +
    inlayCount * inlayLaborCost +
    stoneWeight * stonePrice).toFixed(2)
  );
  if (this.currentInboundOrder.settle_type === 'price') {
    const goldPrice = parseFloat(row.gold_price) || 0;
    row.gold_amount = Number((effectiveWeight * goldPrice).toFixed(2));
  }
  this.calculateTotals();
},
calculateTotals() {
  if (!this.currentInboundOrder || !this.currentInboundOrder.details) return;
  const details = this.currentInboundOrder.details;
  this.currentInboundOrder.total_weight = Number(details.reduce((sum, item) => sum + (item.weight_type === 'weight' ? (parseFloat(item.weight) || 0) * (parseInt(item.quantity) || 1) : 0), 0).toFixed(2));
  this.currentInboundOrder.total_pure_weight = Number(details.reduce((sum, item) => sum + (item.weight_type === 'pure_weight' ? (parseFloat(item.pure_weight) || 0) * (parseInt(item.quantity) || 1) : 0), 0).toFixed(2));
  this.currentInboundOrder.total_cost = Number(details.reduce((sum, item) => sum + (parseFloat(item.total_cost) || 0), 0).toFixed(2));
  this.totalQuantity = details.reduce((sum, item) => sum + (parseInt(item.quantity) || 0), 0);
  if (this.currentInboundOrder.settle_type === 'price') {
    this.currentInboundOrder.total_gold_amount = Number(details.reduce((sum, item) => sum + (parseFloat(item.gold_amount) || 0), 0).toFixed(2));
  } else {
    this.currentInboundOrder.total_gold_amount = 0;
  }
},
        restrictNumberInput(row, field, decimals) {
          let value = row[field].toString();
          value = value.replace(/[^0-9.]/g, '');
          const parts = value.split('.');
          if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
          }
          if (parts.length > 1 && decimals > 0) {
            parts[1] = parts[1].slice(0, decimals);
            value = parts.join('.');
          } else if (decimals === 0 && parts.length > 1) {
            value = parts[0];
          }
          row[field] = value;
          console.log(`Input updated: ${field} = ${value}`);
        },
        generateEAN13() {
          let code = Math.floor(100000000000 + Math.random() * 900000000000).toString();
          let sum = 0;
          for (let i = 0; i < 12; i++) sum += (i % 2 === 0 ? 1 : 3) * parseInt(code[i]);
          const checkDigit = (10 - (sum % 10)) % 10;
          return code + checkDigit;
        },
        copyText(text) {
          console.log('Attempting to copy text:', text);
          if (!document.hasFocus()) {
            this.$message.error('页面未聚焦，请点击页面后再复制');
            return;
          }
          navigator.clipboard.writeText(text)
            .then(() => {
              this.$message.success('已复制到剪贴板');
            })
            .catch(err => {
              console.error('Clipboard error:', err);
              this.$message.error('复制失败，请手动复制: ' + text);
            });
        },
        printVoucher() {
          if (this.currentInboundOrder && this.currentInboundOrder.id) {
            axios.post('/api/printVoucher', { type: 'inbound', order_id: this.currentInboundOrder.id }, { responseType: 'blob' })
              .then(response => {
                const url = window.URL.createObjectURL(new Blob([response.data]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `inbound_voucher_${this.currentInboundOrder.order_number}.xlsx`);
                document.body.appendChild(link);
                link.click();
              });
          } else if (this.selectedRows.length > 0) {
            this.selectedRows.forEach(row => {
              axios.post('/api/printVoucher', { type: 'inbound', order_id: row.id }, { responseType: 'blob' })
                .then(response => {
                  const url = window.URL.createObjectURL(new Blob([response.data]));
                  const link = document.createElement('a');
                  link.href = url;
                  link.setAttribute('download', `inbound_voucher_${row.order_number}.xlsx`);
                  document.body.appendChild(link);
                  link.click();
                });
            });
          }
        },
        printBarcodes(barcodes) {
          axios.post('/api/printBarcodes', { barcodes, template: 'default' }, { responseType: 'blob' })
            .then(response => {
              const url = window.URL.createObjectURL(new Blob([response.data]));
              const link = document.createElement('a');
              link.href = url;
              link.setAttribute('download', `barcodes_${this.currentInboundOrder.order_number}.pdf`);
              document.body.appendChild(link);
              link.click();
            });
        },
        importData() {
          alert('导入功能待实现');
        },
        exportData() {
          const data = this.inboundOrders.map(order => ({
            order_number: order.order_number,
            date: order.date,
            supplier: order.supplier?.short_name,
            counter: order.counter?.name,
            total_cost: order.total_cost,
          }));
          const worksheet = XLSX.utils.json_to_sheet(data);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, 'InboundOrders');
          const buffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
          const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.setAttribute('download', `inbound_orders_${this.formatDate(new Date(), 'yyyyMMdd')}.xlsx`);
          document.body.appendChild(link);
          link.click();
        },
        handleSelectionChange(val) {
          this.selectedRows = val;
        },
        loadSupplierData() {
          // 可扩展逻辑
        },
        addBatchWeight() {
          if (this.batchWeights.length < 50) {
            this.batchWeights.push({ weight: '', pure_weight: '' });
          }
        },
        removeBatchWeight(index) {
          this.batchWeights.splice(index, 1);
        },
        updateBatchSubCategories() {
          const parentId = this.batchForm.product_code;
          this.filteredBatchSubCategories = this.categories.filter(cat => cat.parent_id === parentId);
          this.batchForm.product_name = '';
          console.log('Batch subcategories:', this.filteredBatchSubCategories);
        },
        submitBatchAdd() {
          this.batchWeights.forEach(weight => {
            const effectiveWeight = this.batchForm.weight_type === 'weight' ? parseFloat(weight.weight) || 0 : parseFloat(weight.pure_weight) || 0;
            const total_cost = Number(
              (effectiveWeight * (parseFloat(this.batchForm.labor_cost) || 0) +
              1 * (parseFloat(this.batchForm.extra_fee) || 0) +
              (parseInt(this.batchForm.inlay_count) || 0) * (parseFloat(this.batchForm.inlay_labor_cost) || 0) +
              (parseFloat(this.batchForm.stone_weight) || 0) * (parseFloat(this.batchForm.stone_price) || 0)).toFixed(2)
            );
            const barcode = this.generateEAN13();
            const category = this.categories.find(cat => (cat.code || cat.name) === this.batchForm.product_name);
            const newDetail = {
              barcode,
              product_code: this.categories.find(cat => cat.id === this.batchForm.product_code).name,
              product_name: category ? `${category.name} (${category.code || '无代码'})` : this.batchForm.product_name,
              weight_type: this.batchForm.weight_type,
              weight: this.batchForm.weight_type === 'weight' ? Number((parseFloat(weight.weight) || 0).toFixed(2)) : 0,
              pure_weight: this.batchForm.weight_type === 'pure_weight' ? Number((parseFloat(weight.pure_weight) || 0).toFixed(2)) : 0,
              labor_cost: Number((parseFloat(this.batchForm.labor_cost) || 0).toFixed(2)),
              quantity: 1,
              extra_fee: Number((parseFloat(this.batchForm.extra_fee) || 0).toFixed(2)),
              inlay_count: parseInt(this.batchForm.inlay_count) || 0,
              inlay_labor_cost: Number((parseFloat(this.batchForm.inlay_labor_cost) || 0).toFixed(2)),
              stone_weight: Number((parseFloat(this.batchForm.stone_weight) || 0).toFixed(2)),
              stone_price: Number((parseFloat(this.batchForm.stone_price) || 0).toFixed(2)),
              total_cost: total_cost,
              remark: '',
            };
            if (this.currentInboundOrder.settle_type === 'price') {
              newDetail.gold_price = Number((parseFloat(this.batchForm.gold_price) || 0).toFixed(2));
              newDetail.gold_amount = Number((effectiveWeight * (parseFloat(this.batchForm.gold_price) || 0)).toFixed(2));
            }
            this.currentInboundOrder.details.push(newDetail);
          });
          this.calculateTotals();
          this.showBatchAddDialog = false;
          this.batchForm = {
            product_code: '',
            product_name: '',
            labor_cost: '',
            extra_fee: '',
            inlay_count: 0,
            inlay_labor_cost: '',
            stone_weight: '',
            stone_price: '',
            gold_price: '',
            weight_type: 'weight', // 默认金重
          };
          this.batchWeights = [{ weight: '', pure_weight: '' }];
        },
        filterCategory(query) {
          if (query) {
            this.filteredCategories = this.uniqueParentCategories.filter(parent => parent.name.toLowerCase().includes(query.toLowerCase()));
          } else {
            this.filteredCategories = [...this.uniqueParentCategories];
          }
          console.log('Filtered categories after filter:', this.filteredCategories);
        },
        filterProductName(index) {
          return (query) => {
            if (query) {
              const filtered = this.filteredSubCategories[index].filter(category =>
                category.name.toLowerCase().includes(query.toLowerCase()) ||
                (category.code && category.code.toLowerCase().includes(query.toLowerCase()))
              );
              this.$set(this.filteredSubCategories, index, filtered);
            } else {
              const parentId = this.currentInboundOrder.details[index].product_code;
              this.$set(this.filteredSubCategories, index, this.categories.filter(cat => cat.parent_id === parentId));
            }
            console.log('Filtered subcategories for index', index, ':', this.filteredSubCategories[index]);
          };
        },
        formatDate(date, formatStr) {
          const pad = (num) => String(num).padStart(2, '0');
          const year = date.getFullYear();
          const month = pad(date.getMonth() + 1);
          const day = pad(date.getDate());
          const hours = pad(date.getHours());
          const minutes = pad(date.getMinutes());
          const seconds = pad(date.getSeconds());
          if (formatStr === 'yyyyMMdd') return `${year}${month}${day}`;
          if (formatStr === 'yyyy-MM-dd HH:mm:ss') return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
          return `${year}-${month}-${day}`;
        },
        getSupplierName(supplierId) {
          const supplier = this.suppliers.find(s => s.id === supplierId);
          return supplier ? supplier.short_name : '未选择';
        },
        getCounterName(counterId) {
          const counter = this.counters.find(c => c.id === counterId);
          return counter ? counter.name : '未选择';
        },
      },
      mounted() {
        console.log('Mounted, fetching data...');
        this.fetchSuppliers();
        this.fetchCounters();
        this.fetchCategories();
        this.fetchInboundOrders();
      },
    });
  </script>
  <script src="https://unpkg.com/date-fns@2.30.0/dist/date-fns.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</body>
</html>